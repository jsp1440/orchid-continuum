<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Discovery Leaderboard | Five Cities Orchid Society</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .leaderboard-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .rank-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .rank-1 { background: linear-gradient(45deg, #ffd700, #ffed4e); color: #333; }
        .rank-2 { background: linear-gradient(45deg, #c0c0c0, #e8e8e8); color: #333; }
        .rank-3 { background: linear-gradient(45deg, #cd7f32, #daa520); color: white; }
        .rank-other { background: linear-gradient(45deg, #667eea, #764ba2); color: white; }
        
        .player-row {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .filter-tabs {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 20px 0;
        }
        
        .tab-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .crown {
            font-size: 1.5em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.3);">
        <div class="container">
            <a class="navbar-brand" href="/discovery">
                <i data-feather="trophy"></i> 
                Discovery Leaderboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/discovery">
                    <i data-feather="arrow-left"></i> Back to Game
                </a>
                <a class="nav-link" href="/">
                    <i data-feather="home"></i> Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Page Header -->
        <div class="text-center text-white mb-5">
            <h1 class="display-4 mb-3">
                üèÜ Discovery Champions
            </h1>
            <p class="lead">
                See who's leading the orchid species discovery challenge!
            </p>
        </div>

        <!-- Time Period Filters -->
        <div class="filter-tabs text-center">
            <button class="tab-button active" onclick="loadLeaderboard('all')" id="tab-all">
                All Time
            </button>
            <button class="tab-button" onclick="loadLeaderboard('monthly')" id="tab-monthly">
                This Month
            </button>
            <button class="tab-button" onclick="loadLeaderboard('weekly')" id="tab-weekly">
                This Week
            </button>
            <button class="tab-button" onclick="loadLeaderboard('daily')" id="tab-daily">
                Today
            </button>
        </div>

        <!-- Leaderboard Stats Overview -->
        <div class="leaderboard-card">
            <h4 class="text-white mb-3">
                <i data-feather="bar-chart-2"></i> Competition Stats
            </h4>
            <div class="stats-grid" id="leaderboardStats">
                <div class="stat-card text-white">
                    <h4 id="totalPlayers">-</h4>
                    <p>Total Players</p>
                </div>
                <div class="stat-card text-white">
                    <h4 id="totalGames">-</h4>
                    <p>Games Played</p>
                </div>
                <div class="stat-card text-white">
                    <h4 id="averageScore">-</h4>
                    <p>Average Score</p>
                </div>
                <div class="stat-card text-white">
                    <h4 id="topScore">-</h4>
                    <p>Highest Score</p>
                </div>
            </div>
        </div>

        <!-- Top Players -->
        <div class="leaderboard-card">
            <h4 class="text-white mb-4">
                <i data-feather="award"></i> Top Discovery Champions
            </h4>
            
            <div id="leaderboardContent">
                <div class="text-center text-light">
                    <i data-feather="loader" style="width: 48px; height: 48px; animation: spin 1s linear infinite;"></i>
                    <p>Loading leaderboard...</p>
                </div>
            </div>
        </div>

        <!-- Your Ranking -->
        <div class="leaderboard-card" id="yourRanking" style="display: none;">
            <h4 class="text-white mb-3">
                <i data-feather="user"></i> Your Ranking
            </h4>
            <div class="player-row" id="currentPlayerRow">
                <!-- Will be populated with current player's stats -->
            </div>
        </div>

        <!-- Achievement Showcase -->
        <div class="leaderboard-card">
            <h4 class="text-white mb-3">
                <i data-feather="star"></i> Recent Achievements
            </h4>
            <div id="recentAchievements">
                <p class="text-light">Recent achievement unlocks will appear here...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTimePeriod = 'all';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            loadLeaderboard('all');
        });

        async function loadLeaderboard(timePeriod) {
            currentTimePeriod = timePeriod;
            
            // Update active tab
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${timePeriod}`).classList.add('active');
            
            // Show loading
            document.getElementById('leaderboardContent').innerHTML = `
                <div class="text-center text-light">
                    <i data-feather="loader" style="width: 48px; height: 48px; animation: spin 1s linear infinite;"></i>
                    <p>Loading leaderboard...</p>
                </div>
            `;
            feather.replace();

            try {
                const response = await fetch(`/discovery/api/leaderboard?time_period=${timePeriod}&limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    displayLeaderboard(data.leaderboard);
                    updateStats(data.leaderboard);
                } else {
                    showError('Failed to load leaderboard');
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showError('Network error loading leaderboard');
            }
        }

        function displayLeaderboard(leaderboard) {
            const content = document.getElementById('leaderboardContent');
            
            if (!leaderboard || leaderboard.length === 0) {
                content.innerHTML = `
                    <div class="text-center text-light">
                        <i data-feather="users"></i>
                        <p>No players yet for this time period. Be the first to play!</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            let leaderboardHtml = '';
            
            leaderboard.forEach((player, index) => {
                const rank = player.rank || (index + 1);
                const rankClass = getRankClass(rank);
                const percentage = player.max_score > 0 ? 
                    Math.round((player.score / player.max_score) * 100) : 0;
                
                const crown = rank <= 3 ? getCrownEmoji(rank) : '';
                const completionTime = player.completion_time ? 
                    formatTime(player.completion_time) : 'N/A';
                
                leaderboardHtml += `
                    <div class="player-row">
                        <div class="rank-badge ${rankClass}">
                            ${rank}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white mb-1">
                                        ${escapeHtml(player.player_name)}${crown}
                                    </h6>
                                    <small class="text-light">
                                        ${player.game_type} ‚Ä¢ ${percentage}% accuracy ‚Ä¢ ${completionTime}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <h5 class="text-primary mb-0">${player.score.toLocaleString()}</h5>
                                    <small class="text-muted">points</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = leaderboardHtml;
            feather.replace();
        }

        function updateStats(leaderboard) {
            if (!leaderboard || leaderboard.length === 0) {
                document.getElementById('totalPlayers').textContent = '0';
                document.getElementById('totalGames').textContent = '0';
                document.getElementById('averageScore').textContent = '0';
                document.getElementById('topScore').textContent = '0';
                return;
            }
            
            const totalPlayers = new Set(leaderboard.map(p => p.player_name)).size;
            const totalGames = leaderboard.length;
            const averageScore = Math.round(
                leaderboard.reduce((sum, p) => sum + p.score, 0) / totalGames
            );
            const topScore = Math.max(...leaderboard.map(p => p.score));
            
            document.getElementById('totalPlayers').textContent = totalPlayers.toLocaleString();
            document.getElementById('totalGames').textContent = totalGames.toLocaleString();
            document.getElementById('averageScore').textContent = averageScore.toLocaleString();
            document.getElementById('topScore').textContent = topScore.toLocaleString();
        }

        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }

        function getCrownEmoji(rank) {
            const crowns = { 1: 'üëë', 2: 'ü•à', 3: 'ü•â' };
            return `<span class="crown">${crowns[rank] || ''}</span>`;
        }

        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return 'N/A';
            
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            
            if (mins > 0) {
                return `${mins}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            document.getElementById('leaderboardContent').innerHTML = `
                <div class="text-center">
                    <div class="alert alert-danger">
                        <i data-feather="alert-circle"></i> ${message}
                    </div>
                    <button class="btn btn-outline-light" onclick="loadLeaderboard(currentTimePeriod)">
                        <i data-feather="refresh-cw"></i> Retry
                    </button>
                </div>
            `;
            feather.replace();
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadLeaderboard(currentTimePeriod);
        }, 30000);
    </script>
</body>
</html>