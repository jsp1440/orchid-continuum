<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchid Discovery Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .discovery-container {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .search-section {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .search-input {
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 15px;
        }
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
        }
        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .filter-pill {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 6px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .filter-pill:hover, .filter-pill.active {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }
        .orchid-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .orchid-card {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .orchid-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            background: rgba(255,255,255,0.25);
        }
        .orchid-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.7);
        }
        .orchid-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: #FFD700;
        }
        .orchid-details {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.8);
        }
        .search-stats {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .help-text {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .help-text strong {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="discovery-container">
        <!-- Header -->
        <div class="text-center mb-4">
            <h2 class="mb-2">üîç Orchid Discovery Center</h2>
            <p class="mb-0">Search, Browse & Identify Orchids from Our Database</p>
        </div>

        <!-- Help Instructions -->
        <div class="help-text">
            <strong>How to Use:</strong> Enter orchid names (genus, species, or common names) in the search box below. 
            Use filter pills to narrow results by growing conditions, climate zones, or geographic regions. 
            This searches our Orchid Continuum database with {{ widget_data.total_orchids or 0 }} orchid records.
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="row">
                <div class="col-md-8">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Search orchids by name, genus, species..." 
                           onkeyup="performSearch()" autocomplete="off">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-light w-100" onclick="clearSearch()">
                        <i data-feather="x"></i> Clear Search
                    </button>
                </div>
            </div>
            
            <!-- Filter Pills -->
            <div class="filter-pills">
                <div class="filter-pill" onclick="filterByClimate('tropical')" data-filter="tropical">
                    üå¥ Tropical
                </div>
                <div class="filter-pill" onclick="filterByClimate('temperate')" data-filter="temperate">
                    üçÇ Temperate
                </div>
                <div class="filter-pill" onclick="filterByClimate('cool')" data-filter="cool">
                    ‚ùÑÔ∏è Cool
                </div>
                <div class="filter-pill" onclick="filterByGenus('Cattleya')" data-filter="cattleya">
                    Cattleya
                </div>
                <div class="filter-pill" onclick="filterByGenus('Phalaenopsis')" data-filter="phalaenopsis">
                    Phalaenopsis
                </div>
                <div class="filter-pill" onclick="filterByGenus('Dendrobium')" data-filter="dendrobium">
                    Dendrobium
                </div>
            </div>
        </div>

        <!-- Search Stats -->
        <div class="search-stats" id="searchStats">
            Database contains {{ widget_data.total_orchids or 0 }} orchid records. Start typing to search...
        </div>

        <!-- Loading State -->
        <div class="loading-spinner" id="loadingSpinner" style="display: none;">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Searching...</span>
            </div>
            <p class="mt-2">Searching orchid database...</p>
        </div>

        <!-- Results Grid -->
        <div class="orchid-grid" id="resultsGrid">
            {% if widget_data.orchids %}
                {% for orchid in widget_data.orchids %}
                <div class="orchid-card" onclick="viewOrchidDetails({{ orchid.id }})">
                    {% if orchid.image_url and orchid.image_url != '/static/images/orchid_placeholder.svg' %}
                        <img src="{{ orchid.image_url }}" alt="{{ orchid.display_name }}" class="orchid-image"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="orchid-image" style="display: none;">
                            <i data-feather="image" style="width: 48px; height: 48px;"></i>
                        </div>
                    {% elif orchid.google_drive_id %}
                        <img src="/api/drive-photo/{{ orchid.google_drive_id }}" alt="{{ orchid.display_name }}" class="orchid-image"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="orchid-image" style="display: none;">
                            <i data-feather="image" style="width: 48px; height: 48px;"></i>
                        </div>
                    {% else %}
                        <div class="orchid-image">
                            <i data-feather="image" style="width: 48px; height: 48px;"></i>
                        </div>
                    {% endif %}
                    
                    <div class="orchid-name">{{ orchid.display_name or orchid.scientific_name }}</div>
                    <div class="orchid-details">
                        {% if orchid.genus %}<strong>Genus:</strong> {{ orchid.genus }}<br>{% endif %}
                        {% if orchid.species %}<strong>Species:</strong> {{ orchid.species }}<br>{% endif %}
                        {% if orchid.native_habitat %}<strong>Habitat:</strong> {{ orchid.native_habitat[:50] }}{% if orchid.native_habitat|length > 50 %}...{% endif %}<br>{% endif %}
                        {% if orchid.climate_preference %}<strong>Climate:</strong> {{ orchid.climate_preference|title }}{% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-results col-12">
                    <i data-feather="search" style="width: 64px; height: 64px; margin-bottom: 15px;"></i>
                    <h4>No Orchids Found</h4>
                    <p>Try searching for orchid names or use the filter options above.</p>
                </div>
            {% endif %}
        </div>

        <!-- No Results State -->
        <div class="no-results" id="noResults" style="display: none;">
            <i data-feather="search" style="width: 64px; height: 64px; margin-bottom: 15px;"></i>
            <h4>No Results Found</h4>
            <p>Try different search terms or clear filters to see all orchids.</p>
        </div>
    </div>

    <script>
        let searchTimeout;
        let currentFilters = {};
        
        function performSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('searchInput').value.trim();
                if (query.length >= 2) {
                    searchOrchids(query);
                } else if (query.length === 0) {
                    loadDefaultOrchids();
                }
            }, 300);
        }
        
        function searchOrchids(query) {
            showLoading(true);
            updateSearchStats(`Searching for "${query}"...`);
            
            // Build search URL with filters
            const params = new URLSearchParams({
                q: query,
                limit: 12,
                ...currentFilters
            });
            
            fetch(`/api/search-orchids?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    displayOrchids(data.orchids, `Found ${data.total} orchids matching "${query}"`);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showError('Search failed. Please try again.');
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function loadDefaultOrchids() {
            showLoading(true);
            updateSearchStats('Loading recent orchids...');
            
            fetch('/api/recent-orchids')
                .then(response => response.json())
                .then(data => {
                    displayOrchids(data.orchids || [], 'Showing recent orchids');
                })
                .catch(error => {
                    console.error('Load error:', error);
                    showError('Failed to load orchids.');
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function parseSearchResults(html, query) {
            // This is a simplified parser - in production you'd use a proper API
            const resultsFound = html.includes('orchid-card') || html.includes('result');
            const count = (html.match(/orchid-card/g) || []).length;
            
            if (resultsFound && count > 0) {
                updateSearchStats(`Found ${count} orchids matching "${query}"`);
                // For now, show a placeholder message
                showSearchMessage(`Search for "${query}" completed. ${count} results found.`);
            } else {
                showNoResults();
                updateSearchStats(`No orchids found for "${query}"`);
            }
        }
        
        function displayOrchids(orchids, message) {
            const grid = document.getElementById('resultsGrid');
            const noResults = document.getElementById('noResults');
            
            if (orchids.length === 0) {
                grid.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            updateSearchStats(message || `Showing ${orchids.length} orchids`);
            
            grid.innerHTML = orchids.map(orchid => `
                <div class="orchid-card" onclick="viewOrchidDetails(${orchid.id})">
                    <div class="orchid-image">
                        ${orchid.image_url ? 
                            `<img src="${orchid.image_url}" alt="${orchid.name}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" onerror="this.style.display='none'">` : 
                            '<i data-feather="image" style="width: 48px; height: 48px;"></i>'
                        }
                    </div>
                    <div class="orchid-name">${orchid.name || orchid.scientific_name}</div>
                    <div class="orchid-details">
                        ${orchid.genus ? `<strong>Genus:</strong> ${orchid.genus}<br>` : ''}
                        ${orchid.species ? `<strong>Species:</strong> ${orchid.species}<br>` : ''}
                        ${orchid.habitat ? `<strong>Habitat:</strong> ${orchid.habitat.substring(0, 50)}...` : ''}
                    </div>
                </div>
            `).join('');
            
            // Re-initialize Feather icons
            feather.replace();
        }
        
        function filterByClimate(climate) {
            toggleFilter('climate', climate);
            applyFilters();
        }
        
        function filterByGenus(genus) {
            toggleFilter('genus', genus);
            applyFilters();
        }
        
        function toggleFilter(type, value) {
            const pill = document.querySelector(`[data-filter="${value}"]`);
            
            if (currentFilters[type] === value) {
                delete currentFilters[type];
                pill.classList.remove('active');
            } else {
                currentFilters[type] = value;
                // Remove active from other pills of same type
                document.querySelectorAll('.filter-pill.active').forEach(p => {
                    if (p.dataset.filter !== value) p.classList.remove('active');
                });
                pill.classList.add('active');
            }
        }
        
        function applyFilters() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                searchOrchids(query);
            } else {
                loadDefaultOrchids();
            }
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentFilters = {};
            document.querySelectorAll('.filter-pill.active').forEach(pill => {
                pill.classList.remove('active');
            });
            loadDefaultOrchids();
        }
        
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('resultsGrid').style.display = show ? 'none' : 'grid';
        }
        
        function showNoResults() {
            document.getElementById('resultsGrid').innerHTML = '';
            document.getElementById('noResults').style.display = 'block';
        }
        
        function showSearchMessage(message) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = `
                <div class="col-12 text-center p-4">
                    <i data-feather="search" style="width: 48px; height: 48px; margin-bottom: 15px;"></i>
                    <h5>${message}</h5>
                    <p>This demonstrates the search functionality. In the full version, actual orchid results would appear here.</p>
                </div>
            `;
            feather.replace();
        }
        
        function showError(message) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = `
                <div class="col-12 text-center p-4">
                    <i data-feather="alert-circle" style="width: 48px; height: 48px; margin-bottom: 15px; color: #ff6b6b;"></i>
                    <h5>Search Error</h5>
                    <p>${message}</p>
                </div>
            `;
            feather.replace();
        }
        
        function updateSearchStats(message) {
            document.getElementById('searchStats').textContent = message;
        }
        
        function viewOrchidDetails(orchidId) {
            // Navigate to orchid detail page
            window.open(`/orchid/${orchidId}`, '_blank');
        }
        
        // Initialize Feather icons
        feather.replace();
        
        // Load initial orchids
        loadDefaultOrchids();
    </script>
</body>
</html>