<!-- World Map Widget for External Integration -->
<div class="orchid-map-widget" style="min-height: 400px;">
    <div class="widget-header mb-3">
        <h5 class="mb-0">
            <i class="fas fa-globe"></i> Global Orchid Distribution
        </h5>
        <p class="text-muted small mb-0">Interactive satellite map showing orchid locations worldwide</p>
    </div>
    
    <div class="map-container" style="height: 400px; border-radius: 8px; overflow: hidden;">
        <div id="widget-orchid-map-{{ widget_data.widget_id }}" style="height: 100%; width: 100%;"></div>
    </div>
    
    <div class="map-controls mt-3">
        <div class="row">
            <div class="col-md-6">
                <select id="widget-filter-genus-{{ widget_data.widget_id }}" class="form-select form-select-sm">
                    <option value="">All Genera</option>
                </select>
            </div>
            <div class="col-md-6">
                <select id="widget-filter-climate-{{ widget_data.widget_id }}" class="form-select form-select-sm">
                    <option value="">All Climates</option>
                    <option value="cool">Cool</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="warm">Warm</option>
                </select>
            </div>
        </div>
        <div class="mt-2 text-center">
            <small class="text-muted">
                <span id="widget-location-count-{{ widget_data.widget_id }}">Loading...</span> locations •
                <a href="{{ widget_data.full_map_url or '/map' }}" target="_blank" class="text-decoration-none">View Full Map</a>
            </small>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const widgetId = '{{ widget_data.widget_id }}';
    const mapElementId = `widget-orchid-map-${widgetId}`;
    
    // Wait for map container to be visible
    const mapContainer = document.getElementById(mapElementId);
    if (!mapContainer) return;
    
    // Initialize the widget map
    const map = L.map(mapElementId).setView([0, 0], 2);
    
    // Satellite base layer for widget
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '© Esri',
        maxZoom: 10
    });
    satelliteLayer.addTo(map);
    
    // Marker cluster group
    const markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 30,
        disableClusteringAtZoom: 8
    });
    map.addLayer(markerClusterGroup);
    
    let allLocations = [];
    
    // Custom orchid icon for widget
    const orchidIcon = L.divIcon({
        className: 'widget-orchid-marker',
        html: '<div style="background: #e91e63; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.4);"></div>',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
    });
    
    // Load orchid location data
    const apiUrl = '{{ widget_data.api_base_url or "/api" }}/orchid-locations';
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.locations) {
                allLocations = data.locations;
                updateWidgetMarkers();
                populateWidgetFilters();
                
                // Fit map to show all markers
                if (allLocations.length > 0) {
                    const bounds = L.latLngBounds();
                    allLocations.forEach(loc => bounds.extend([loc.lat, loc.lng]));
                    map.fitBounds(bounds.pad(0.1));
                }
                
                document.getElementById(`widget-location-count-${widgetId}`).textContent = `${allLocations.length}`;
            }
        })
        .catch(error => {
            console.error('Widget map error:', error);
            document.getElementById(mapElementId).innerHTML = 
                '<div class="d-flex align-items-center justify-content-center h-100 text-muted">' +
                '<div class="text-center"><i class="fas fa-exclamation-triangle mb-2"></i><br>Map data unavailable</div>' +
                '</div>';
        });
    
    function updateWidgetMarkers() {
        markerClusterGroup.clearLayers();
        
        const genusFilter = document.getElementById(`widget-filter-genus-${widgetId}`).value;
        const climateFilter = document.getElementById(`widget-filter-climate-${widgetId}`).value;
        
        let filtered = allLocations.filter(location => {
            if (genusFilter && location.genus !== genusFilter) return false;
            if (climateFilter && location.climate !== climateFilter) return false;
            return true;
        });
        
        filtered.forEach(location => {
            const marker = L.marker([location.lat, location.lng], { icon: orchidIcon });
            
            const popupContent = `
                <div style="text-align: center;">
                    <strong>${location.name}</strong><br>
                    ${location.scientific_name ? `<em style="color: #666;">${location.scientific_name}</em><br>` : ''}
                    ${location.region ? `<small>Region: ${location.region}</small><br>` : ''}
                    <a href="${'{{ widget_data.base_url or "" }}'}/orchid/${location.id}" target="_blank" style="font-size: 12px;">View Details</a>
                </div>
            `;
            marker.bindPopup(popupContent);
            markerClusterGroup.addLayer(marker);
        });
        
        document.getElementById(`widget-location-count-${widgetId}`).textContent = `${filtered.length}`;
    }
    
    function populateWidgetFilters() {
        const genera = [...new Set(allLocations.map(l => l.genus).filter(g => g))].sort();
        const genusSelect = document.getElementById(`widget-filter-genus-${widgetId}`);
        genera.forEach(genus => {
            genusSelect.innerHTML += `<option value="${genus}">${genus}</option>`;
        });
    }
    
    // Event listeners
    document.getElementById(`widget-filter-genus-${widgetId}`).addEventListener('change', updateWidgetMarkers);
    document.getElementById(`widget-filter-climate-${widgetId}`).addEventListener('change', updateWidgetMarkers);
});
</script>

<style>
.orchid-map-widget {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.widget-orchid-marker {
    background: none;
    border: none;
}

.orchid-map-widget .leaflet-popup-content-wrapper {
    background: white;
    color: #333;
    border-radius: 4px;
}

.orchid-map-widget .leaflet-popup-tip {
    background: white;
}
</style>