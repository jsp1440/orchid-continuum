<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∫ FCOS Orchid Bingo</title>
    <style>
        :root {
            --primary-purple: #9b59b6;
            --secondary-green: #7a9c59;
            --accent-orange: #ef6c00;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-dark: #2c3e50;
            --success-green: #27ae60;
            --warning-orange: #f39c12;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #f3eafa 0%, #e8f5e8 100%);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-green));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .game-controls {
            padding: 2rem;
            background: var(--light-bg);
            border-bottom: 1px solid #e0e0e0;
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        select, input, button {
            padding: 0.7rem 1rem;
            border: 2px solid var(--secondary-green);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
        }

        select, input {
            background: white;
            color: var(--text-dark);
        }

        button {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-green));
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .primary-btn {
            background: linear-gradient(135deg, var(--accent-orange), #e67e22);
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        .game-area {
            padding: 2rem;
            text-align: center;
        }

        .bingo-board {
            display: inline-grid;
            gap: 8px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .bingo-board.size-4 {
            grid-template-columns: repeat(4, 80px);
        }

        .bingo-board.size-5 {
            grid-template-columns: repeat(5, 90px);
        }

        .bingo-tile {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border: 3px solid var(--secondary-green);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .bingo-tile:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(122, 156, 89, 0.3);
        }

        .bingo-tile.marked {
            background: linear-gradient(135deg, var(--success-green), #2ecc71);
            color: white;
            border-color: #27ae60;
            transform: scale(0.95);
        }

        .bingo-tile.free {
            background: linear-gradient(135deg, var(--warning-orange), #e67e22);
            color: white;
            border-style: dashed;
            border-color: #d35400;
        }

        .bingo-tile.winning {
            animation: celebrate 0.6s ease-in-out;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            margin: 2rem 0;
            border-radius: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-purple);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 0.25rem;
        }

        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-message.success {
            background: linear-gradient(135deg, #d5f4e6, #a2f2d2);
            color: #27ae60;
            border: 2px solid #2ecc71;
        }

        .status-message.info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #2196f3;
            border: 2px solid #3498db;
        }

        .status-message.waiting {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: var(--accent-orange);
            border: 2px solid #f39c12;
        }

        .badge-display {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .badge {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #8b4513;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid #daa520;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.3);
            animation: fadeInScale 0.5s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .game-modes {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 0.8rem 1.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-purple);
            margin: 1rem 0;
        }

        .leaderboard {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }

        .leaderboard h3 {
            color: var(--primary-purple);
            margin-bottom: 1rem;
            text-align: center;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 10px;
            border-left: 4px solid var(--secondary-green);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .bingo-board.size-4 {
                grid-template-columns: repeat(4, 70px);
            }
            
            .bingo-board.size-5 {
                grid-template-columns: repeat(5, 65px);
            }
            
            .bingo-tile {
                font-size: 0.7rem;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå∫ FCOS Orchid Bingo</h1>
            <p>Test your orchid knowledge while having fun!</p>
        </div>

        <div class="game-controls">
            <div class="controls-row">
                <div class="control-group">
                    <label for="boardSize">Board Size:</label>
                    <select id="boardSize">
                        <option value="4">4√ó4 Grid</option>
                        <option value="5" selected>5√ó5 Grid (Free Center)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="seedInput">Seed (Optional):</label>
                    <input type="text" id="seedInput" placeholder="Enter seed..." maxlength="20">
                </div>

                <button id="newGameBtn" class="primary-btn">üéØ New Game</button>
                <button id="clearMarksBtn">üîÑ Clear Marks</button>
            </div>

            <div class="game-modes">
                <button class="mode-btn" onclick="startDailyChallenge()">‚≠ê Daily Challenge</button>
                <button class="mode-btn" onclick="showLeaderboard()">üèÜ Leaderboard</button>
                <button class="mode-btn" onclick="showInstructions()">‚ùì How to Play</button>
            </div>
        </div>

        <div class="game-area">
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-value" id="pointsDisplay">0</span>
                    <span class="stat-label">Points</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="timeDisplay">00:00</span>
                    <span class="stat-label">Time</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="bingoCount">0</span>
                    <span class="stat-label">Bingos</span>
                </div>
            </div>

            <div class="status-message waiting" id="statusMessage">
                üéÆ Click "New Game" to start playing Orchid Bingo!
            </div>

            <div class="badge-display" id="badgeDisplay"></div>

            <div id="bingoBoard" class="bingo-board size-5"></div>

            <div class="leaderboard" id="leaderboardSection" style="display: none;">
                <h3>üèÜ Top Players</h3>
                <div id="leaderboardList"></div>
            </div>
        </div>
    </div>

    <script>
        class OrchidBingo {
            constructor() {
                this.board = [];
                this.markedTiles = new Set();
                this.gameActive = false;
                this.startTime = null;
                this.timerInterval = null;
                this.points = 0;
                this.bingoCount = 0;
                this.gameId = null;
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('newGameBtn').addEventListener('click', () => this.startNewGame());
                document.getElementById('clearMarksBtn').addEventListener('click', () => this.clearMarks());
                document.getElementById('boardSize').addEventListener('change', () => this.updateBoardSize());
            }

            async startNewGame() {
                const size = parseInt(document.getElementById('boardSize').value);
                const seed = document.getElementById('seedInput').value.trim();

                try {
                    const response = await fetch('/widgets/orchid-bingo/generate-board', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ size, seed })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.board = data.board;
                        this.gameId = data.game_id;
                        this.renderBoard();
                        this.resetGame();
                        this.startTimer();
                        this.updateStatusMessage('üéØ Mark the orchid terms to get BINGO!', 'info');
                    } else {
                        this.showError('Failed to generate board: ' + data.error);
                    }
                } catch (error) {
                    this.showError('Network error: ' + error.message);
                }
            }

            renderBoard() {
                const boardElement = document.getElementById('bingoBoard');
                const size = this.board.length;
                
                boardElement.className = `bingo-board size-${size}`;
                boardElement.innerHTML = '';

                this.board.forEach((row, rowIndex) => {
                    row.forEach((cell, colIndex) => {
                        const tile = document.createElement('div');
                        tile.className = 'bingo-tile';
                        tile.textContent = cell.word;
                        tile.dataset.row = rowIndex;
                        tile.dataset.col = colIndex;

                        if (cell.is_free) {
                            tile.classList.add('free', 'marked');
                            this.markedTiles.add(`${rowIndex}-${colIndex}`);
                        }

                        tile.addEventListener('click', () => this.toggleTile(rowIndex, colIndex, tile));
                        boardElement.appendChild(tile);
                    });
                });

                this.gameActive = true;
            }

            toggleTile(row, col, tileElement) {
                if (!this.gameActive) return;
                
                const tileKey = `${row}-${col}`;
                const cell = this.board[row][col];

                if (cell.is_free) return; // Can't toggle free space

                if (this.markedTiles.has(tileKey)) {
                    this.markedTiles.delete(tileKey);
                    tileElement.classList.remove('marked');
                } else {
                    this.markedTiles.add(tileKey);
                    tileElement.classList.add('marked');
                }

                this.checkForBingo();
            }

            async checkForBingo() {
                const markedPositions = Array.from(this.markedTiles).map(key => {
                    const [row, col] = key.split('-').map(Number);
                    return { row, col };
                });

                try {
                    const response = await fetch('/widgets/orchid-bingo/check-bingo', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ marked_positions: markedPositions })
                    });

                    const data = await response.json();
                    
                    if (data.success && data.has_bingo) {
                        this.handleBingo(data);
                    }
                } catch (error) {
                    console.error('Error checking bingo:', error);
                }
            }

            handleBingo(bingoData) {
                this.gameActive = false;
                this.stopTimer();
                
                // Update stats
                this.points += bingoData.points_earned;
                this.bingoCount += bingoData.total_patterns;
                
                // Show winning tiles
                this.highlightWinningPatterns(bingoData.winning_patterns);
                
                // Display badges
                this.displayBadges(bingoData.badges_earned);
                
                // Update display
                this.updatePointsDisplay();
                this.updateBingoDisplay();
                this.updateStatusMessage(`üéâ BINGO! You earned ${bingoData.points_earned} points!`, 'success');
                
                // Submit score
                this.submitScore(bingoData);
            }

            highlightWinningPatterns(patterns) {
                const boardElement = document.getElementById('bingoBoard');
                const size = this.board.length;

                patterns.forEach(pattern => {
                    if (pattern.type === 'row') {
                        for (let col = 0; col < size; col++) {
                            const tile = boardElement.children[pattern.index * size + col];
                            tile.classList.add('winning');
                        }
                    } else if (pattern.type === 'column') {
                        for (let row = 0; row < size; row++) {
                            const tile = boardElement.children[row * size + pattern.index];
                            tile.classList.add('winning');
                        }
                    } else if (pattern.type === 'diagonal') {
                        if (pattern.index === 0) {
                            // Main diagonal
                            for (let i = 0; i < size; i++) {
                                const tile = boardElement.children[i * size + i];
                                tile.classList.add('winning');
                            }
                        } else {
                            // Anti-diagonal
                            for (let i = 0; i < size; i++) {
                                const tile = boardElement.children[i * size + (size - 1 - i)];
                                tile.classList.add('winning');
                            }
                        }
                    }
                });
            }

            displayBadges(badges) {
                const badgeDisplay = document.getElementById('badgeDisplay');
                
                badges.forEach(badge => {
                    const badgeElement = document.createElement('div');
                    badgeElement.className = 'badge';
                    badgeElement.textContent = `${badge.icon} ${badge.name} (+${badge.points}pts)`;
                    badgeDisplay.appendChild(badgeElement);
                });
            }

            async submitScore(bingoData) {
                const completionTime = this.getElapsedTime();
                
                try {
                    const response = await fetch('/widgets/orchid-bingo/submit-score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            points: this.points,
                            badges: bingoData.badges_earned,
                            completion_time: completionTime,
                            patterns_found: bingoData.total_patterns
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        console.log('Score submitted successfully!');
                    }
                } catch (error) {
                    console.error('Error submitting score:', error);
                }
            }

            clearMarks() {
                if (!this.gameActive) return;

                this.markedTiles.clear();
                
                // Re-add free spaces
                this.board.forEach((row, rowIndex) => {
                    row.forEach((cell, colIndex) => {
                        if (cell.is_free) {
                            this.markedTiles.add(`${rowIndex}-${colIndex}`);
                        }
                    });
                });

                // Update UI
                const tiles = document.querySelectorAll('.bingo-tile');
                tiles.forEach(tile => {
                    tile.classList.remove('marked', 'winning');
                    
                    if (tile.classList.contains('free')) {
                        tile.classList.add('marked');
                    }
                });
            }

            resetGame() {
                this.markedTiles.clear();
                this.gameActive = false;
                this.stopTimer();
                this.startTime = null;
                
                // Don't reset points/bingos - cumulative across games
                this.updateTimeDisplay();
            }

            startTimer() {
                this.startTime = new Date();
                this.timerInterval = setInterval(() => {
                    this.updateTimeDisplay();
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            getElapsedTime() {
                if (!this.startTime) return 0;
                return Math.floor((new Date() - this.startTime) / 1000);
            }

            updateTimeDisplay() {
                const elapsed = this.getElapsedTime();
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timeDisplay').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            updatePointsDisplay() {
                document.getElementById('pointsDisplay').textContent = this.points;
            }

            updateBingoDisplay() {
                document.getElementById('bingoCount').textContent = this.bingoCount;
            }

            updateBoardSize() {
                if (this.gameActive) {
                    if (confirm('Starting a new game will lose your current progress. Continue?')) {
                        this.startNewGame();
                    }
                }
            }

            updateStatusMessage(message, type) {
                const statusElement = document.getElementById('statusMessage');
                statusElement.textContent = message;
                statusElement.className = `status-message ${type}`;
            }

            showError(message) {
                this.updateStatusMessage(`‚ùå ${message}`, 'error');
            }
        }

        // Global functions for mode buttons
        async function startDailyChallenge() {
            try {
                const response = await fetch('/widgets/orchid-bingo/daily-challenge');
                const data = await response.json();
                
                if (data.success) {
                    game.board = data.board;
                    game.renderBoard();
                    game.resetGame();
                    game.startTimer();
                    game.updateStatusMessage(`‚≠ê Daily Challenge: ${data.description}`, 'info');
                }
            } catch (error) {
                console.error('Error loading daily challenge:', error);
            }
        }

        async function showLeaderboard() {
            try {
                const response = await fetch('/widgets/orchid-bingo/leaderboard');
                const data = await response.json();
                
                if (data.success) {
                    const leaderboardSection = document.getElementById('leaderboardSection');
                    const leaderboardList = document.getElementById('leaderboardList');
                    
                    leaderboardList.innerHTML = '';
                    
                    data.leaderboard.forEach((entry, index) => {
                        const entryElement = document.createElement('div');
                        entryElement.className = 'leaderboard-entry';
                        entryElement.innerHTML = `
                            <span>#${index + 1} - ${entry.points} points</span>
                            <span>${entry.board_size}√ó${entry.board_size} - ${entry.patterns_found} patterns</span>
                        `;
                        leaderboardList.appendChild(entryElement);
                    });
                    
                    leaderboardSection.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function showInstructions() {
            alert(`üå∫ How to Play Orchid Bingo:

1. Click "New Game" to generate a random board
2. Click tiles to mark them when you know the orchid term
3. Get 5 in a row (horizontal, vertical, or diagonal) for BINGO!
4. Earn points and badges for different achievements
5. Try the Daily Challenge for bonus points!

üéØ Scoring:
‚Ä¢ Basic BINGO: 100 points
‚Ä¢ Multiple patterns: +50 points each
‚Ä¢ Speed bonus: +50 points (under 1 minute)
‚Ä¢ Daily Challenge: 2x multiplier

üèÜ Badges:
‚Ä¢ First Bingo (50pts) - Complete your first game
‚Ä¢ Speed Demon (100pts) - Finish in under 1 minute  
‚Ä¢ Pattern Finder (125pts) - Find multiple patterns
‚Ä¢ Orchid Expert (75pts) - Advanced terminology knowledge`);
        }

        // Initialize the game
        const game = new OrchidBingo();
        
        // Auto-start timer display
        game.updateTimeDisplay();
        game.updatePointsDisplay();
        game.updateBingoDisplay();
    </script>
</body>
</html>