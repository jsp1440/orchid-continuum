<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon One CRM Integration - FCOS Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #6B3FA0, #9B59B6);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .integration-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background-color: #28a745; }
        .status-simulation { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .automation-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .action-button {
            padding: 15px;
            border: 2px solid #6B3FA0;
            border-radius: 10px;
            background: white;
            transition: all 0.3s ease;
            text-align: center;
            cursor: pointer;
        }
        .action-button:hover {
            background: #6B3FA0;
            color: white;
        }
        .member-lookup {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1><i data-feather="users"></i> Neon One CRM Integration</h1>
            <p class="lead">Automate FCOS member management and email workflows</p>
        </div>
    </div>

    <div class="container">
        <!-- Connection Status -->
        <div class="integration-card">
            <h3>üîó Connection Status</h3>
            <div id="connectionStatus">
                <span class="status-indicator status-simulation"></span>
                <strong>Simulation Mode</strong> - Add NEON_ONE_API_KEY to enable live integration
            </div>
            <p class="mt-2 text-muted">
                <small>When connected, this system will automatically sync workshop registrations, 
                apply member discounts, and trigger email campaigns.</small>
            </p>
        </div>

        <!-- Member Lookup Tool -->
        <div class="integration-card">
            <h3>üë§ Member Lookup</h3>
            <div class="member-lookup">
                <div class="input-group">
                    <input type="email" class="form-control" id="memberEmail" placeholder="Enter member email address">
                    <button class="btn btn-primary" onclick="lookupMember()">
                        <i data-feather="search"></i> Lookup Member
                    </button>
                </div>
                <div id="memberResults" class="mt-3" style="display: none;"></div>
            </div>
        </div>

        <!-- Automation Actions -->
        <div class="integration-card">
            <h3>ü§ñ Automation Actions</h3>
            <div class="automation-actions">
                <div class="action-button" onclick="sendWorkshopReminders()">
                    <i data-feather="mail"></i>
                    <h5>Workshop Reminders</h5>
                    <p>Send automated reminders to registered participants</p>
                </div>
                
                <div class="action-button" onclick="syncAllRegistrations()">
                    <i data-feather="refresh-cw"></i>
                    <h5>Sync Registrations</h5>
                    <p>Sync all workshop registrations with Neon One</p>
                </div>
                
                <div class="action-button" onclick="checkMemberRenewals()">
                    <i data-feather="calendar"></i>
                    <h5>Member Renewals</h5>
                    <p>Check for members needing renewal</p>
                </div>
                
                <div class="action-button" onclick="generateEngagementReport()">
                    <i data-feather="bar-chart-2"></i>
                    <h5>Engagement Report</h5>
                    <p>Generate member engagement analysis</p>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="integration-card">
            <h3>üìã Recent CRM Activity</h3>
            <div id="recentActivity">
                <p class="text-muted">Loading recent CRM synchronization activity...</p>
            </div>
        </div>

        <!-- Email Campaign Setup -->
        <div class="integration-card">
            <h3>üìß Email Campaign Management</h3>
            <p>Configure automated email campaigns in Neon One:</p>
            <ul>
                <li><strong>FCOS_WORKSHOP_WELCOME</strong> - Welcome email for new workshop registrants</li>
                <li><strong>FCOS_WORKSHOP_REMINDER</strong> - Workshop reminder sent 3 days before</li>
                <li><strong>FCOS_MEMBER_RENEWAL</strong> - Membership renewal reminder</li>
                <li><strong>FCOS_NEW_MEMBER_WELCOME</strong> - Welcome sequence for new members</li>
            </ul>
            <p class="text-muted">
                <small>These campaign IDs should be configured in your Neon One email automation settings.</small>
            </p>
        </div>

        <!-- Workshop Registration Analytics -->
        <div class="integration-card">
            <h3>üìä Workshop Analytics</h3>
            <div class="row" id="workshopStats">
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 id="totalRegistrations">-</h4>
                        <p>Total Registrations</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 id="memberRegistrations">-</h4>
                        <p>FCOS Members</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 id="paidRegistrations">-</h4>
                        <p>Paid Online</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 id="conversionRate">-</h4>
                        <p>Payment Rate</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
    <script>
        // Initialize Feather icons
        feather.replace();

        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadWorkshopStats();
            loadRecentActivity();
        });

        function lookupMember() {
            const email = document.getElementById('memberEmail').value;
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            const resultsDiv = document.getElementById('memberResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Looking up member...';

            fetch(`/api/neon-member-lookup/${encodeURIComponent(email)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.found) {
                        resultsDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h5>‚úÖ Member Found</h5>
                                <p><strong>Name:</strong> ${data.member.name}</p>
                                <p><strong>Status:</strong> ${data.member.membership_status}</p>
                                <p><strong>Level:</strong> ${data.member.membership_level}</p>
                                <p><strong>Account ID:</strong> ${data.member.account_id}</p>
                            </div>
                        `;
                    } else {
                        resultsDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <h5>‚ö†Ô∏è Member Not Found</h5>
                                <p>Email ${email} was not found in the FCOS membership database.</p>
                                <p><small>This person may be a workshop participant who isn't a current member.</small></p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>‚ùå Lookup Failed</h5>
                            <p>Error connecting to Neon One: ${error.message}</p>
                        </div>
                    `;
                });
        }

        function sendWorkshopReminders() {
            const workshopDate = '2025-09-28'; // Could make this dynamic
            
            if (!confirm('Send workshop reminders to all registered participants?')) return;

            fetch(`/admin/neon-workshop-reminders/${workshopDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Workshop reminders sent successfully!\n\nMembers: ${data.reminder_results.members_notified}\nNon-members: ${data.reminder_results.non_members_notified}\nTotal: ${data.reminder_results.total_registrations}`);
                    } else {
                        alert('Failed to send workshop reminders');
                    }
                })
                .catch(error => {
                    alert('Error sending reminders: ' + error.message);
                });
        }

        function syncAllRegistrations() {
            if (!confirm('Sync all workshop registrations with Neon One? This may take a few minutes.')) return;
            
            alert('Registration sync started. This feature will process all registrations in the background.');
            // In real implementation, would trigger batch sync process
        }

        function checkMemberRenewals() {
            fetch('/admin/neon-sync-renewals')
                .then(response => response.json())
                .then(data => {
                    alert(`Member renewal check completed!\n\nMembers expiring soon: ${data.members_expiring_soon || 0}\nRenewal emails sent: ${data.renewal_emails_sent || 0}`);
                })
                .catch(error => {
                    alert('Error checking renewals: ' + error.message);
                });
        }

        function generateEngagementReport() {
            fetch('/admin/neon-engagement-report')
                .then(response => response.json())
                .then(data => {
                    const report = `
Member Engagement Report
Generated: ${new Date(data.generated_at).toLocaleString()}

Workshop Registrations: ${data.total_workshop_registrations}
Paid Registrations: ${data.paid_registrations}
Payment Rate: ${data.payment_rate}%

Member vs Non-Member Breakdown:
- Current Members: ${data.member_vs_non_member_breakdown.members}
- Non-Members: ${data.member_vs_non_member_breakdown.non_members}
- Conversion Opportunities: ${data.member_vs_non_member_breakdown.member_conversion_opportunities}
                    `;
                    alert(report);
                })
                .catch(error => {
                    alert('Error generating report: ' + error.message);
                });
        }

        function loadWorkshopStats() {
            fetch('/api/workshop-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalRegistrations').textContent = data.total_registrations || 0;
                    document.getElementById('memberRegistrations').textContent = data.member_registrations || 0;
                    document.getElementById('paidRegistrations').textContent = data.paid_registrations || 0;
                    document.getElementById('conversionRate').textContent = (data.payment_rate || 0) + '%';
                })
                .catch(error => {
                    console.error('Error loading workshop stats:', error);
                });
        }

        function loadRecentActivity() {
            const activities = [
                'Workshop registration synced for jane.doe@email.com',
                'Member discount applied for FCOS member John Smith',
                'Welcome email triggered for new workshop participant',
                'Member renewal reminder sent to 15 members'
            ];

            const activityHtml = activities.map(activity => 
                `<div class="d-flex align-items-center mb-2">
                    <i data-feather="check-circle" class="text-success me-2"></i>
                    <span>${activity}</span>
                    <small class="text-muted ms-auto">${Math.floor(Math.random() * 60)} min ago</small>
                </div>`
            ).join('');

            document.getElementById('recentActivity').innerHTML = activityHtml;
            feather.replace();
        }
    </script>
</body>
</html>