<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Monitoring Dashboard - Five Cities Orchid Society</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css">
    <style>
        .status-healthy { color: #28a745; }
        .status-degraded { color: #ffc107; }
        .status-down { color: #dc3545; }
        .status-critical { color: #dc3545; }
        
        .metric-card {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }
        
        .metric-card.healthy { border-left-color: #28a745; }
        .metric-card.degraded { border-left-color: #ffc107; }
        .metric-card.critical { border-left-color: #dc3545; }
        
        .live-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 8px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        
        .widget-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 0.5rem;
        }
        
        .severity-high { border-left: 4px solid #dc3545; }
        .severity-medium { border-left: 4px solid #ffc107; }
        .severity-low { border-left: 4px solid #28a745; }
    </style>
</head>
<body class="bg-light">
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <span class="live-indicator"></span>
                        Live Monitoring Dashboard
                    </h1>
                    <p class="mb-0">Real-time system health and member feedback monitoring</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light me-2" id="runDiagnosticBtn">
                        <i data-feather="activity"></i> Run Full Diagnostic
                    </button>
                    <button class="btn btn-outline-light" id="refreshBtn">
                        <i data-feather="refresh-cw"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- System Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <i data-feather="monitor" class="me-2"></i>
                        <h5 class="mb-0">System Overview</h5>
                        <span class="badge bg-secondary ms-auto" id="lastUpdateTime">Loading...</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="metric-card card h-100" id="overallStatusCard">
                                    <div class="card-body text-center">
                                        <i data-feather="server" class="text-muted mb-2" style="width: 48px; height: 48px;"></i>
                                        <h3 id="overallStatus">Loading...</h3>
                                        <p class="text-muted mb-0">Overall Status</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="metric-card card h-100">
                                    <div class="card-body text-center">
                                        <i data-feather="database" class="text-muted mb-2" style="width: 48px; height: 48px;"></i>
                                        <h3 id="totalOrchids">-</h3>
                                        <p class="text-muted mb-0">Total Orchids</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="metric-card card h-100">
                                    <div class="card-body text-center">
                                        <i data-feather="alert-circle" class="text-muted mb-2" style="width: 48px; height: 48px;"></i>
                                        <h3 id="openIssues">-</h3>
                                        <p class="text-muted mb-0">Open Issues</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="metric-card card h-100">
                                    <div class="card-body text-center">
                                        <i data-feather="flag" class="text-muted mb-2" style="width: 48px; height: 48px;"></i>
                                        <h3 id="pendingFlags">-</h3>
                                        <p class="text-muted mb-0">Pending Flags</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget Status Grid -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="grid" class="me-2"></i>
                            Widget Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="widget-status-grid" id="widgetStatusGrid">
                            <!-- Widget status cards will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Activity Feed -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="message-square" class="me-2"></i>
                            Recent Member Feedback
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="activity-feed" id="feedbackFeed">
                            <!-- Feedback items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i data-feather="flag" class="me-2"></i>
                            Recent Photo Flags
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="activity-feed" id="flagsFeed">
                            <!-- Flag items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnostic Results Modal -->
    <div class="modal fade" id="diagnosticModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i data-feather="activity" class="me-2"></i>
                        Comprehensive Diagnostic Results
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="diagnosticResults">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Running diagnostic...</span>
                            </div>
                            <p class="mt-3">Running comprehensive diagnostic...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.js"></script>
    <script>
        class MonitoringDashboard {
            constructor() {
                this.refreshInterval = null;
                this.autoRefresh = true;
                this.init();
            }
            
            init() {
                // Initialize feather icons
                feather.replace();
                
                // Start auto-refresh
                this.startAutoRefresh();
                
                // Load initial data
                this.loadDashboardData();
                
                // Bind events
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadDashboardData();
                });
                
                document.getElementById('runDiagnosticBtn').addEventListener('click', () => {
                    this.runComprehensiveDiagnostic();
                });
            }
            
            startAutoRefresh() {
                if (this.autoRefresh) {
                    this.refreshInterval = setInterval(() => {
                        this.loadDashboardData();
                    }, 30000); // Refresh every 30 seconds
                }
            }
            
            async loadDashboardData() {
                try {
                    const response = await fetch('/api/admin/live-dashboard-data');
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.updateDashboard(data);
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showError('Failed to load dashboard data: ' + error.message);
                }
            }
            
            updateDashboard(data) {
                // Update last update time
                document.getElementById('lastUpdateTime').textContent = 
                    new Date(data.timestamp).toLocaleString();
                
                // Update system stats
                const stats = data.system_stats || {};
                document.getElementById('totalOrchids').textContent = stats.total_orchids || '-';
                document.getElementById('openIssues').textContent = stats.open_feedback || '-';
                document.getElementById('pendingFlags').textContent = stats.pending_flags || '-';
                
                // Update overall status (simplified)
                const overallStatus = this.calculateOverallStatus(data.widget_statuses);
                this.updateOverallStatus(overallStatus);
                
                // Update widget status grid
                this.updateWidgetStatusGrid(data.widget_statuses || {});
                
                // Update activity feeds
                this.updateFeedbackFeed(data.recent_feedback || []);
                this.updateFlagsFeed(data.recent_flags || []);
            }
            
            calculateOverallStatus(widgetStatuses) {
                if (!widgetStatuses || Object.keys(widgetStatuses).length === 0) {
                    return 'unknown';
                }
                
                const statuses = Object.values(widgetStatuses).map(w => w.status);
                
                if (statuses.includes('critical') || statuses.includes('down')) {
                    return 'critical';
                } else if (statuses.includes('degraded')) {
                    return 'degraded';
                } else if (statuses.every(s => s === 'healthy')) {
                    return 'healthy';
                } else {
                    return 'unknown';
                }
            }
            
            updateOverallStatus(status) {
                const statusElement = document.getElementById('overallStatus');
                const cardElement = document.getElementById('overallStatusCard');
                
                statusElement.textContent = status.toUpperCase();
                statusElement.className = `status-${status}`;
                
                cardElement.className = `metric-card card h-100 ${status}`;
            }
            
            updateWidgetStatusGrid(widgetStatuses) {
                const grid = document.getElementById('widgetStatusGrid');
                grid.innerHTML = '';
                
                const widgetNames = {
                    'featured': 'Featured Orchid',
                    'gallery': 'Gallery Widget', 
                    'discovery': 'Discovery Widget',
                    'orchid_of_day': 'Orchid of the Day'
                };
                
                Object.entries(widgetStatuses).forEach(([widgetName, status]) => {
                    const card = this.createWidgetStatusCard(
                        widgetNames[widgetName] || widgetName, 
                        status
                    );
                    grid.appendChild(card);
                });
            }
            
            createWidgetStatusCard(name, status) {
                const card = document.createElement('div');
                card.className = `card metric-card ${status.status || 'unknown'}`;
                
                const responseTime = status.response_time_ms ? `${status.response_time_ms}ms` : '-';
                const successRate = status.success_rate ? `${status.success_rate.toFixed(1)}%` : '-';
                const lastChecked = status.last_checked ? 
                    new Date(status.last_checked).toLocaleTimeString() : 'Never';
                
                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">${name}</h6>
                            <span class="badge bg-${this.getStatusBadgeColor(status.status)}">${status.status || 'Unknown'}</span>
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">Response</small><br>
                                <strong>${responseTime}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Success</small><br>
                                <strong>${successRate}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Errors</small><br>
                                <strong>${status.error_count || 0}</strong>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block">Last checked: ${lastChecked}</small>
                        ${status.last_error ? `<small class="text-danger">Error: ${status.last_error}</small>` : ''}
                    </div>
                `;
                
                return card;
            }
            
            getStatusBadgeColor(status) {
                switch (status) {
                    case 'healthy': return 'success';
                    case 'degraded': return 'warning';
                    case 'critical':
                    case 'down': return 'danger';
                    default: return 'secondary';
                }
            }
            
            updateFeedbackFeed(feedback) {
                const feed = document.getElementById('feedbackFeed');
                feed.innerHTML = '';
                
                if (feedback.length === 0) {
                    feed.innerHTML = '<div class="text-center text-muted py-4">No recent feedback</div>';
                    return;
                }
                
                feedback.forEach(item => {
                    const feedItem = document.createElement('div');
                    feedItem.className = `activity-item severity-${item.severity}`;
                    
                    const timeAgo = this.getTimeAgo(item.created_at);
                    
                    feedItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${item.type.replace('_', ' ').toUpperCase()}</strong>
                                <span class="badge bg-${this.getSeverityColor(item.severity)} ms-2">${item.severity}</span>
                                <p class="mb-1 mt-1">${item.description}</p>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewFeedback(${item.id})">
                                View
                            </button>
                        </div>
                    `;
                    
                    feed.appendChild(feedItem);
                });
            }
            
            updateFlagsFeed(flags) {
                const feed = document.getElementById('flagsFeed');
                feed.innerHTML = '';
                
                if (flags.length === 0) {
                    feed.innerHTML = '<div class="text-center text-muted py-4">No recent flags</div>';
                    return;
                }
                
                flags.forEach(item => {
                    const flagItem = document.createElement('div');
                    flagItem.className = 'activity-item';
                    
                    const timeAgo = this.getTimeAgo(item.created_at);
                    
                    flagItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>Orchid #${item.orchid_id}</strong>
                                <span class="badge bg-warning ms-2">${item.reason.replace('_', ' ')}</span>
                                <p class="mb-1 mt-1">Status: ${item.status}</p>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="dashboard.viewOrchid(${item.orchid_id})">
                                View
                            </button>
                        </div>
                    `;
                    
                    feed.appendChild(flagItem);
                });
            }
            
            getSeverityColor(severity) {
                switch (severity) {
                    case 'high': return 'danger';
                    case 'medium': return 'warning';
                    case 'low': return 'success';
                    default: return 'secondary';
                }
            }
            
            getTimeAgo(timestamp) {
                const now = new Date();
                const time = new Date(timestamp);
                const diffMs = now - time;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
                return `${Math.floor(diffMins / 1440)}d ago`;
            }
            
            async runComprehensiveDiagnostic() {
                const modal = new bootstrap.Modal(document.getElementById('diagnosticModal'));
                modal.show();
                
                try {
                    const response = await fetch('/api/admin/comprehensive-diagnostic');
                    const data = await response.json();
                    
                    this.displayDiagnosticResults(data);
                    
                } catch (error) {
                    console.error('Error running diagnostic:', error);
                    document.getElementById('diagnosticResults').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Diagnostic Failed:</strong> ${error.message}
                        </div>
                    `;
                }
            }
            
            displayDiagnosticResults(data) {
                const resultsDiv = document.getElementById('diagnosticResults');
                
                let html = `
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="alert alert-${this.getStatusAlertClass(data.overall_status)}">
                                <h5>Overall Status: ${data.overall_status.toUpperCase()}</h5>
                                <p>Diagnostic completed at: ${new Date(data.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            ${data.issues && data.issues.length > 0 ? `
                                <div class="alert alert-warning">
                                    <h6>Issues Found:</h6>
                                    <ul class="mb-0">
                                        ${data.issues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : '<div class="alert alert-success">No issues detected</div>'}
                        </div>
                    </div>
                `;
                
                // Widget results
                if (data.widgets) {
                    html += '<h6>Widget Status:</h6><div class="row mb-3">';
                    Object.entries(data.widgets).forEach(([widget, status]) => {
                        html += `
                            <div class="col-md-3 mb-2">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h6>${widget}</h6>
                                        <span class="badge bg-${this.getStatusBadgeColor(status.status)}">${status.status}</span>
                                        ${status.response_time_ms ? `<br><small>${status.response_time_ms}ms</small>` : ''}
                                        ${status.error ? `<br><small class="text-danger">${status.error}</small>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                // Database and image results
                html += '<div class="row">';
                if (data.database) {
                    html += `
                        <div class="col-md-6">
                            <h6>Database Status:</h6>
                            <div class="card">
                                <div class="card-body">
                                    <span class="badge bg-${this.getStatusBadgeColor(data.database.status)}">${data.database.status}</span>
                                    ${data.database.orchid_count ? `<p>Orchids: ${data.database.orchid_count}</p>` : ''}
                                    ${data.database.response_time_ms ? `<p>Response: ${data.database.response_time_ms}ms</p>` : ''}
                                    ${data.database.error ? `<p class="text-danger">Error: ${data.database.error}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (data.images) {
                    html += `
                        <div class="col-md-6">
                            <h6>Image System Status:</h6>
                            <div class="card">
                                <div class="card-body">
                                    <span class="badge bg-${this.getStatusBadgeColor(data.images.status)}">${data.images.status}</span>
                                    ${data.images.google_drive_success_rate !== undefined ? `
                                        <p>Google Drive: ${data.images.google_drive_success_rate.toFixed(1)}% (${data.images.google_drive_working}/${data.images.google_drive_tested})</p>
                                    ` : ''}
                                    ${data.images.production_ready_images ? `<p>Production images: ${data.images.production_ready_images}</p>` : ''}
                                    ${data.images.error ? `<p class="text-danger">Error: ${data.images.error}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                
                resultsDiv.innerHTML = html;
            }
            
            getStatusAlertClass(status) {
                switch (status) {
                    case 'healthy': return 'success';
                    case 'degraded': return 'warning';
                    case 'critical': return 'danger';
                    default: return 'info';
                }
            }
            
            showError(message) {
                // Simple error display - could be enhanced
                console.error(message);
                alert('Error: ' + message);
            }
            
            viewFeedback(feedbackId) {
                // Placeholder - implement feedback detail view
                alert(`View feedback #${feedbackId} (feature to be implemented)`);
            }
            
            viewOrchid(orchidId) {
                // Open orchid detail page
                window.open(`/orchid/${orchidId}`, '_blank');
            }
        }
        
        // Initialize dashboard when DOM is loaded
        let dashboard;
        document.addEventListener('DOMContentLoaded', function() {
            dashboard = new MonitoringDashboard();
        });
        
        // Replace feather icons when page loads
        feather.replace();
    </script>
</body>
</html>