{% extends "base.html" %}
{% set page_title = "Photo Editor - " + session_data.orchid_name %}

{% block content %}
<div class="container-fluid photo-editor-container">
    <div class="row">
        <!-- Sidebar Controls -->
        <div class="col-md-3 bg-dark text-light photo-editor-sidebar">
            <div class="p-3">
                <!-- Header -->
                <div class="mb-4">
                    <h5>
                        <i data-feather="edit-3" class="me-2"></i>Photo Editor
                    </h5>
                    <p class="small text-muted mb-0">{{ session_data.orchid_name }}</p>
                    <p class="small text-muted">Session: {{ session_id[:8] }}...</p>
                </div>

                <!-- Quick Actions -->
                <div class="mb-4">
                    <div class="btn-group w-100 mb-2">
                        <button class="btn btn-outline-light btn-sm" onclick="undoLastOperation()">
                            <i data-feather="rotate-ccw" class="me-1"></i>Undo
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="resetToOriginal()">
                            <i data-feather="refresh-cw" class="me-1"></i>Reset
                        </button>
                    </div>
                    <button class="btn btn-success w-100 btn-sm" onclick="showSaveOptions()">
                        <i data-feather="save" class="me-1"></i>Save & Export
                    </button>
                </div>

                <!-- Tools Accordion -->
                <div class="accordion accordion-flush" id="editingTools">
                    <!-- Basic Adjustments -->
                    <div class="accordion-item bg-dark">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-dark text-light" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#basicAdjustments">
                                <i data-feather="sliders" class="me-2"></i>Basic Adjustments
                            </button>
                        </h2>
                        <div id="basicAdjustments" class="accordion-collapse collapse show" data-bs-parent="#editingTools">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <label for="brightness" class="form-label small">Brightness</label>
                                    <input type="range" class="form-range" id="brightness" min="0.1" max="2" step="0.1" value="1">
                                    <span class="small text-muted" id="brightnessValue">100%</span>
                                </div>
                                <div class="mb-3">
                                    <label for="contrast" class="form-label small">Contrast</label>
                                    <input type="range" class="form-range" id="contrast" min="0.1" max="2" step="0.1" value="1">
                                    <span class="small text-muted" id="contrastValue">100%</span>
                                </div>
                                <div class="mb-3">
                                    <label for="saturation" class="form-label small">Saturation</label>
                                    <input type="range" class="form-range" id="saturation" min="0" max="2" step="0.1" value="1">
                                    <span class="small text-muted" id="saturationValue">100%</span>
                                </div>
                                <div class="mb-3">
                                    <label for="sharpness" class="form-label small">Sharpness</label>
                                    <input type="range" class="form-range" id="sharpness" min="0" max="3" step="0.1" value="1">
                                    <span class="small text-muted" id="sharpnessValue">100%</span>
                                </div>
                                <button class="btn btn-primary btn-sm w-100" onclick="applyBasicAdjustments()">
                                    Apply Adjustments
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Crop & Resize -->
                    <div class="accordion-item bg-dark">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-dark text-light" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#cropResize">
                                <i data-feather="crop" class="me-2"></i>Crop & Resize
                            </button>
                        </h2>
                        <div id="cropResize" class="accordion-collapse collapse" data-bs-parent="#editingTools">
                            <div class="accordion-body">
                                <div class="mb-3">
                                    <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="enableCropTool()">
                                        <i data-feather="crop" class="me-1"></i>Enable Crop Tool
                                    </button>
                                    <button class="btn btn-outline-light btn-sm w-100" onclick="showResizeOptions()">
                                        <i data-feather="maximize-2" class="me-1"></i>Resize Options
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="accordion-item bg-dark">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-dark text-light" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#filters">
                                <i data-feather="filter" class="me-2"></i>Filters
                            </button>
                        </h2>
                        <div id="filters" class="accordion-collapse collapse" data-bs-parent="#editingTools">
                            <div class="accordion-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button class="btn btn-outline-light btn-sm w-100" onclick="applyFilter('sharpen')">
                                            Sharpen
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-light btn-sm w-100" onclick="applyFilter('blur')">
                                            Blur
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-light btn-sm w-100" onclick="applyFilter('botanical_enhance')">
                                            Botanical
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-light btn-sm w-100" onclick="applyFilter('vintage')">
                                            Vintage
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-light btn-sm w-100" onclick="applyFilter('sepia')">
                                            Sepia
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-light btn-sm w-100" onclick="applyFilter('grayscale')">
                                            B&W
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis -->
                    <div class="accordion-item bg-dark">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-dark text-light" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#aiAnalysis">
                                <i data-feather="cpu" class="me-2"></i>AI Plant Analysis
                            </button>
                        </h2>
                        <div id="aiAnalysis" class="accordion-collapse collapse" data-bs-parent="#editingTools">
                            <div class="accordion-body">
                                <button class="btn btn-primary btn-sm w-100 mb-3" onclick="runPlantAnalysis()">
                                    <i data-feather="zap" class="me-1"></i>Analyze Plant Features
                                </button>
                                <div id="analysisResults" class="small text-muted">
                                    Click "Analyze" to get detailed plant analysis including morphological features, 
                                    identification markers, and 3D spatial characteristics.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Info -->
                <div class="mt-4 p-2 bg-secondary rounded">
                    <h6 class="small mb-2">Session Info</h6>
                    <div class="small text-muted">
                        <div>Operations: <span id="operationCount">0</span></div>
                        <div>Original Size: {{ session_data.original_size[0] }}×{{ session_data.original_size[1] }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Editing Area -->
        <div class="col-md-9 photo-editor-main">
            <div class="p-3">
                <!-- Toolbar -->
                <div class="bg-light rounded p-2 mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="zoomIn()">
                                    <i data-feather="zoom-in"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="zoomOut()">
                                    <i data-feather="zoom-out"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="fitToScreen()">
                                    <i data-feather="maximize"></i>
                                </button>
                            </div>
                            <span class="ms-3 small text-muted">Zoom: <span id="zoomLevel">100%</span></span>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('photo_editor.photo_editor_home') }}" class="btn btn-outline-secondary">
                                    <i data-feather="arrow-left" class="me-1"></i>Back
                                </a>
                                <button class="btn btn-outline-primary" onclick="downloadCurrentImage()">
                                    <i data-feather="download" class="me-1"></i>Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Canvas Area -->
                <div class="photo-canvas-container">
                    <div id="imageContainer" class="position-relative">
                        <canvas id="photoCanvas" style="max-width: 100%; border: 1px solid #ddd;"></canvas>
                        <div id="loadingOverlay" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Options Modal -->
<div class="modal fade" id="saveOptionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save & Export Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Format Options</h6>
                        <div class="mb-3">
                            <label for="exportFormat" class="form-label">File Format</label>
                            <select class="form-select" id="exportFormat">
                                <option value="JPEG">JPEG (Recommended)</option>
                                <option value="PNG">PNG (Lossless)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="exportQuality" class="form-label">Quality</label>
                            <input type="range" class="form-range" id="exportQuality" min="60" max="100" value="95">
                            <span class="small text-muted" id="qualityValue">95%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Export Options</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="saveOriginal" checked>
                            <label class="form-check-label" for="saveOriginal">
                                Keep original separate
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="uploadToDrive" checked>
                            <label class="form-check-label" for="uploadToDrive">
                                Upload to Google Drive
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createPackage">
                            <label class="form-check-label" for="createPackage">
                                Create export package
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Preview</h6>
                    <div class="bg-light p-3 rounded">
                        <small class="text-muted">
                            Your edited photo will be saved with all applied modifications while keeping 
                            the original submission separate. Analysis data and edit history will be preserved.
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedImage()">
                    <i data-feather="save" class="me-1"></i>Save & Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resize Modal -->
<div class="modal fade" id="resizeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resize Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newWidth" class="form-label">Width (pixels)</label>
                    <input type="number" class="form-control" id="newWidth" value="{{ session_data.original_size[0] }}">
                </div>
                <div class="mb-3">
                    <label for="newHeight" class="form-label">Height (pixels)</label>
                    <input type="number" class="form-control" id="newHeight" value="{{ session_data.original_size[1] }}">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="maintainAspect" checked>
                    <label class="form-check-label" for="maintainAspect">
                        Maintain aspect ratio
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyResize()">Apply Resize</button>
            </div>
        </div>
    </div>
</div>

<script>
const sessionId = '{{ session_id }}';
let currentZoom = 1;
let operationCount = 0;
let canvas, ctx;
let currentImage = null;

// Initialize editor
document.addEventListener('DOMContentLoaded', function() {
    initializeEditor();
    updateSliderValues();
});

function initializeEditor() {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');
    
    // Load initial image (placeholder for now)
    loadInitialImage();
}

function loadInitialImage() {
    // In production, this would load the actual image
    // For now, create a placeholder
    canvas.width = 800;
    canvas.height = 600;
    ctx.fillStyle = '#f0f0f0';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#666';
    ctx.font = '24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('{{ session_data.orchid_name }}', canvas.width/2, canvas.height/2 - 20);
    ctx.fillText('Photo Editor', canvas.width/2, canvas.height/2 + 20);
}

function updateSliderValues() {
    // Update slider value displays
    document.getElementById('brightness').oninput = function() {
        document.getElementById('brightnessValue').textContent = Math.round(this.value * 100) + '%';
    };
    document.getElementById('contrast').oninput = function() {
        document.getElementById('contrastValue').textContent = Math.round(this.value * 100) + '%';
    };
    document.getElementById('saturation').oninput = function() {
        document.getElementById('saturationValue').textContent = Math.round(this.value * 100) + '%';
    };
    document.getElementById('sharpness').oninput = function() {
        document.getElementById('sharpnessValue').textContent = Math.round(this.value * 100) + '%';
    };
    document.getElementById('exportQuality').oninput = function() {
        document.getElementById('qualityValue').textContent = this.value + '%';
    };
}

// Photo editing functions
function applyBasicAdjustments() {
    showLoading(true);
    
    const adjustments = {
        session_id: sessionId,
        brightness: parseFloat(document.getElementById('brightness').value),
        contrast: parseFloat(document.getElementById('contrast').value),
        saturation: parseFloat(document.getElementById('saturation').value),
        sharpness: parseFloat(document.getElementById('sharpness').value)
    };
    
    fetch('/photo-editor/api/adjust', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(adjustments)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update canvas with new image
            updateCanvasFromBase64(data.image_data);
            operationCount++;
            updateOperationCount();
            showSuccess('Adjustments applied successfully');
        } else {
            showError(data.error || 'Failed to apply adjustments');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

function applyFilter(filterType) {
    showLoading(true);
    
    fetch('/photo-editor/api/filter', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: sessionId,
            filter_type: filterType,
            intensity: 1.0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateCanvasFromBase64(data.image_data);
            operationCount++;
            updateOperationCount();
            showSuccess(`${filterType} filter applied`);
        } else {
            showError(data.error || 'Failed to apply filter');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

function runPlantAnalysis() {
    showLoading(true);
    document.getElementById('analysisResults').innerHTML = 'Analyzing plant features...';
    
    fetch('/photo-editor/api/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({session_id: sessionId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAnalysisResults(data);
            showSuccess('Plant analysis completed');
        } else {
            showError(data.error || 'Analysis failed');
            document.getElementById('analysisResults').innerHTML = 'Analysis failed. Please try again.';
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
        document.getElementById('analysisResults').innerHTML = 'Analysis failed due to network error.';
    })
    .finally(() => {
        showLoading(false);
    });
}

function displayAnalysisResults(data) {
    let html = '<div class="small">';
    if (data.features_detected && data.features_detected.length > 0) {
        html += '<strong>Features Detected:</strong><br>';
        html += data.features_detected.slice(0, 5).join(', ') + '<br><br>';
    }
    if (data.quality_score) {
        html += `<strong>Quality Score:</strong> ${Math.round(data.quality_score * 100)}%<br><br>`;
    }
    if (data.recommendations && data.recommendations.length > 0) {
        html += '<strong>Recommendations:</strong><br>';
        data.recommendations.slice(0, 3).forEach(rec => {
            html += `• ${rec}<br>`;
        });
    }
    html += '</div>';
    document.getElementById('analysisResults').innerHTML = html;
}

function showSaveOptions() {
    const modal = new bootstrap.Modal(document.getElementById('saveOptionsModal'));
    modal.show();
}

function showResizeOptions() {
    const modal = new bootstrap.Modal(document.getElementById('resizeModal'));
    modal.show();
}

function saveEditedImage() {
    const saveOptions = {
        format: document.getElementById('exportFormat').value,
        quality: parseInt(document.getElementById('exportQuality').value),
        save_original: document.getElementById('saveOriginal').checked,
        upload_to_drive: document.getElementById('uploadToDrive').checked,
        create_package: document.getElementById('createPackage').checked
    };
    
    showLoading(true);
    
    fetch('/photo-editor/api/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: sessionId,
            save_options: saveOptions
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Image saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('saveOptionsModal')).hide();
        } else {
            showError(data.error || 'Save failed');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

function undoLastOperation() {
    fetch('/photo-editor/api/undo', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({session_id: sessionId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Undid: ${data.undone_operation}`);
            operationCount = data.operations_remaining;
            updateOperationCount();
            // Reload the image
            location.reload();
        } else {
            showError(data.error || 'Nothing to undo');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    });
}

function downloadCurrentImage() {
    window.open(`/photo-editor/download/${sessionId}`, '_blank');
}

// Utility functions
function updateCanvasFromBase64(base64Data) {
    const img = new Image();
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        currentImage = img;
    };
    img.src = 'data:image/jpeg;base64,' + base64Data;
}

function updateOperationCount() {
    document.getElementById('operationCount').textContent = operationCount;
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) {
        overlay.classList.remove('d-none');
    } else {
        overlay.classList.add('d-none');
    }
}

function showSuccess(message) {
    // Simple alert for now - could be enhanced with toast notifications
    console.log('Success:', message);
}

function showError(message) {
    console.error('Error:', message);
    alert('Error: ' + message);
}

// Zoom functions
function zoomIn() {
    currentZoom = Math.min(currentZoom * 1.2, 5);
    updateZoom();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom / 1.2, 0.1);
    updateZoom();
}

function fitToScreen() {
    currentZoom = 1;
    updateZoom();
}

function updateZoom() {
    canvas.style.transform = `scale(${currentZoom})`;
    document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
}

// Initialize feather icons
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>

<style>
.photo-editor-container {
    height: 100vh;
    overflow: hidden;
}

.photo-editor-sidebar {
    height: 100vh;
    overflow-y: auto;
    border-right: 1px solid #dee2e6;
}

.photo-editor-main {
    height: 100vh;
    overflow-y: auto;
}

.photo-canvas-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    min-height: 400px;
}

#photoCanvas {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 4px;
    transition: transform 0.2s ease;
}

.accordion-button {
    border: none;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
}

.form-range {
    margin-bottom: 0.5rem;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}