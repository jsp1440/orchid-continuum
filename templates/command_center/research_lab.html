{% extends "base.html" %}

{% block title %}Climate Research Lab - AI & Data Analysis{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Research Lab Header -->
    <div class="row bg-gradient-primary text-white py-4 mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 mb-2">ðŸ”¬ Climate Research Lab</h1>
                    <p class="lead mb-0">AI-Powered Research & Statistical Analysis Platform</p>
                </div>
                <div class="text-end">
                    <div class="badge bg-success fs-6 mb-2">AI ASSISTANT ACTIVE</div><br>
                    <small>Enhanced with statistical analysis tools</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Research Tools Dashboard -->
    <div class="row mb-4">
        <!-- AI Research Assistant -->
        <div class="col-lg-4 mb-3">
            <div class="card border-info h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ðŸ¤– AI Research Assistant</h5>
                </div>
                <div class="card-body">
                    <p class="small">Intelligent analysis of research data, experiment suggestions, and scientific insights powered by advanced AI.</p>
                    
                    <div class="mb-3">
                        <strong>Capabilities:</strong>
                        <ul class="small mt-2">
                            <li>Pattern detection in research data</li>
                            <li>Experiment design suggestions</li>
                            <li>Statistical interpretation</li>
                            <li>Research hypothesis generation</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-info btn-sm me-2" onclick="analyzeWithAI()">
                        <i data-feather="brain" class="me-1" style="width: 14px;"></i>
                        Analyze Data
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="suggestExperiments()">
                        <i data-feather="lightbulb" class="me-1" style="width: 14px;"></i>
                        Suggest Experiments
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Collection & Storage -->
        <div class="col-lg-4 mb-3">
            <div class="card border-success h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ðŸ“Š Data Management</h5>
                </div>
                <div class="card-body">
                    <p class="small">Systematic collection, storage, and management of experimental data with quality assurance.</p>
                    
                    <div class="mb-3">
                        <strong>Features:</strong>
                        <ul class="small mt-2">
                            <li>Experiment tracking system</li>
                            <li>Data quality validation</li>
                            <li>Secure database storage</li>
                            <li>Export capabilities</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-success btn-sm me-2" onclick="createExperiment()">
                        <i data-feather="plus" class="me-1" style="width: 14px;"></i>
                        New Experiment
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="viewData()">
                        <i data-feather="database" class="me-1" style="width: 14px;"></i>
                        View Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistical Analysis -->
        <div class="col-lg-4 mb-3">
            <div class="card border-warning h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">ðŸ“ˆ Statistical Analysis</h5>
                </div>
                <div class="card-body">
                    <p class="small">Advanced statistical tools for correlation analysis, regression modeling, and hypothesis testing.</p>
                    
                    <div class="mb-3">
                        <strong>Analysis Types:</strong>
                        <ul class="small mt-2">
                            <li>Correlation analysis</li>
                            <li>Linear/multiple regression</li>
                            <li>ANOVA and t-tests</li>
                            <li>Chi-square tests</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-warning btn-sm me-2" onclick="runCorrelation()">
                        <i data-feather="trending-up" class="me-1" style="width: 14px;"></i>
                        Correlation
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="runRegression()">
                        <i data-feather="activity" class="me-1" style="width: 14px;"></i>
                        Regression
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Science Lab Integration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ðŸ”¬ Science Lab Integration</h5>
                </div>
                <div class="card-body">
                    <p>Seamlessly connect with existing science lab tools for comprehensive research workflows.</p>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-light mb-3">
                                <div class="card-body text-center">
                                    <i data-feather="search" class="text-primary mb-2" style="width: 32px; height: 32px;"></i>
                                    <h6>Enhanced Science Lab</h6>
                                    <p class="small">Advanced AI-powered analysis tools</p>
                                    <a href="/enhanced-science-lab" class="btn btn-primary btn-sm">
                                        Launch Lab
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card border-light mb-3">
                                <div class="card-body text-center">
                                    <i data-feather="layers" class="text-success mb-2" style="width: 32px; height: 32px;"></i>
                                    <h6>Compare & Analyze</h6>
                                    <p class="small">Side-by-side analysis and comparison</p>
                                    <a href="/comparison" class="btn btn-success btn-sm">
                                        Compare Data
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card border-light mb-3">
                                <div class="card-body text-center">
                                    <i data-feather="upload-cloud" class="text-info mb-2" style="width: 32px; height: 32px;"></i>
                                    <h6>Bulk Analyzer</h6>
                                    <p class="small">Process multiple samples at once</p>
                                    <a href="/bulk-analyzer/bulk-upload" class="btn btn-info btn-sm">
                                        Bulk Analysis
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Analysis Interface -->
    <div class="row mb-4" id="ai-analysis-section" style="display: none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ðŸ¤– AI Research Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Analysis Type</h6>
                            <select class="form-select mb-3" id="analysisType">
                                <option value="comprehensive">Comprehensive Analysis</option>
                                <option value="pattern_detection">Pattern Detection</option>
                                <option value="optimization">Optimization Focus</option>
                            </select>
                            
                            <h6>Research Data</h6>
                            <textarea class="form-control mb-3" id="researchData" rows="6" 
                                      placeholder="Enter research data (JSON format or description)..."></textarea>
                            
                            <button class="btn btn-info" onclick="runAIAnalysis()">
                                <i data-feather="play" class="me-2" style="width: 16px;"></i>
                                Run AI Analysis
                            </button>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>AI Insights</h6>
                            <div id="aiInsights" class="border rounded p-3 bg-light" style="min-height: 200px;">
                                <p class="text-muted">AI insights will appear here after analysis...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistical Analysis Interface -->
    <div class="row mb-4" id="stats-analysis-section" style="display: none;">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">ðŸ“ˆ Statistical Analysis Tools</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Analysis Configuration</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Experiment ID</label>
                                <input type="text" class="form-control" id="experimentId" 
                                       placeholder="Enter experiment ID...">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Analysis Type</label>
                                <select class="form-select" id="statsAnalysisType">
                                    <option value="correlation">Correlation Analysis</option>
                                    <option value="regression">Regression Analysis</option>
                                </select>
                            </div>
                            
                            <div id="correlationInputs">
                                <div class="mb-3">
                                    <label class="form-label">Variable 1</label>
                                    <input type="text" class="form-control" id="variable1" 
                                           placeholder="e.g., carbon_transfer_rate">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Variable 2</label>
                                    <input type="text" class="form-control" id="variable2" 
                                           placeholder="e.g., soil_ph">
                                </div>
                            </div>
                            
                            <button class="btn btn-warning" onclick="runStatisticalAnalysis()">
                                <i data-feather="bar-chart-2" class="me-2" style="width: 16px;"></i>
                                Run Analysis
                            </button>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Statistical Results</h6>
                            <div id="statsResults" class="border rounded p-3 bg-light" style="min-height: 250px;">
                                <p class="text-muted">Statistical results will appear here...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Research Activity -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ðŸ“‹ Recent Research Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Activity Type</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                                <tr>
                                    <td>2025-09-08 14:30</td>
                                    <td><span class="badge bg-info">AI Analysis</span></td>
                                    <td>Pattern detection in mycorrhizal data</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-09-08 13:45</td>
                                    <td><span class="badge bg-warning">Statistical</span></td>
                                    <td>Correlation: carbon_rate vs soil_ph</td>
                                    <td><span class="badge bg-success">Completed</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2025-09-08 12:20</td>
                                    <td><span class="badge bg-success">Experiment</span></td>
                                    <td>New partnership efficiency study</td>
                                    <td><span class="badge bg-warning">Active</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">Manage</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Research Lab Interface Functions
function analyzeWithAI() {
    document.getElementById('ai-analysis-section').style.display = 'block';
    document.getElementById('stats-analysis-section').style.display = 'none';
    
    // Scroll to analysis section
    document.getElementById('ai-analysis-section').scrollIntoView({ behavior: 'smooth' });
}

function suggestExperiments() {
    // Call AI experiment suggestion API
    fetch('/ai-research/suggest-experiments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            research_goal: 'Optimize orchid-fungal carbon capture',
            current_data: {
                partnerships_count: 28,
                efficiency_range: '15-85%',
                env_factors: ['pH', 'temperature', 'humidity']
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`AI suggested ${data.experiments.length} new experiments! Check the results panel for details.`);
        }
    });
}

function createExperiment() {
    // Redirect to experiment creation
    window.location.href = '/research-data/';
}

function viewData() {
    // Open data management interface
    window.location.href = '/research-data/';
}

function runCorrelation() {
    document.getElementById('stats-analysis-section').style.display = 'block';
    document.getElementById('ai-analysis-section').style.display = 'none';
    document.getElementById('statsAnalysisType').value = 'correlation';
    
    // Scroll to analysis section
    document.getElementById('stats-analysis-section').scrollIntoView({ behavior: 'smooth' });
}

function runRegression() {
    document.getElementById('stats-analysis-section').style.display = 'block';
    document.getElementById('ai-analysis-section').style.display = 'none';
    document.getElementById('statsAnalysisType').value = 'regression';
    
    // Scroll to analysis section
    document.getElementById('stats-analysis-section').scrollIntoView({ behavior: 'smooth' });
}

function runAIAnalysis() {
    const analysisType = document.getElementById('analysisType').value;
    const researchData = document.getElementById('researchData').value;
    
    const resultsDiv = document.getElementById('aiInsights');
    resultsDiv.innerHTML = '<div class="spinner-border text-info" role="status"><span class="visually-hidden">Analyzing...</span></div> <span class="text-info">AI is analyzing your data...</span>';
    
    fetch('/ai-research/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            analysis_type: analysisType,
            data: JSON.parse(researchData || '{}')
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '<h6 class="text-success">AI Analysis Complete</h6>';
            data.insights.forEach(insight => {
                html += `
                    <div class="mb-3 p-3 border rounded">
                        <h6 class="text-primary">${insight.title}</h6>
                        <p class="small">${insight.description}</p>
                        <div class="text-muted small">
                            Confidence: ${(insight.confidence_score * 100).toFixed(1)}% | 
                            Priority: ${insight.priority}
                        </div>
                    </div>
                `;
            });
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-warning">Analysis failed: ${data.error}</div>`;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
}

function runStatisticalAnalysis() {
    const analysisType = document.getElementById('statsAnalysisType').value;
    const experimentId = document.getElementById('experimentId').value;
    
    const resultsDiv = document.getElementById('statsResults');
    resultsDiv.innerHTML = '<div class="spinner-border text-warning" role="status"><span class="visually-hidden">Computing...</span></div> <span class="text-warning">Running statistical analysis...</span>';
    
    let requestData = { experiment_id: experimentId };
    
    if (analysisType === 'correlation') {
        requestData.variable1 = document.getElementById('variable1').value;
        requestData.variable2 = document.getElementById('variable2').value;
    }
    
    fetch(`/research-data/analyze/${analysisType}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.result;
            let html = `
                <h6 class="text-success">Statistical Analysis Complete</h6>
                <div class="mb-3 p-3 border rounded">
                    <h6 class="text-primary">Results</h6>
            `;
            
            if (analysisType === 'correlation') {
                html += `
                    <p><strong>Correlation Coefficient:</strong> ${result.correlation_coefficient.toFixed(3)}</p>
                    <p><strong>P-value:</strong> ${result.p_value.toFixed(6)}</p>
                    <p><strong>Method:</strong> ${result.method}</p>
                    <p><strong>Effect Size:</strong> ${result.effect_size.toFixed(3)}</p>
                `;
            } else if (analysisType === 'regression') {
                html += `
                    <p><strong>R-squared:</strong> ${result.r_squared.toFixed(3)}</p>
                    <p><strong>P-value:</strong> ${result.p_value.toFixed(6)}</p>
                `;
            }
            
            html += `
                    <div class="mt-3">
                        <h6>Interpretation:</h6>
                        <p class="small">${result.interpretation}</p>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-warning">Analysis failed: ${data.error}</div>`;
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    });
}

// Initialize Feather Icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>
{% endblock %}