{% extends "base.html" %}
{% block title %}SVO Analysis Results - {{ session.session_name }}{% endblock %}

{% block head %}
<style>
    .results-header {
        background: linear-gradient(135deg, #3aa681 0%, #2c8563 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #3aa681;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    
    .chart-image {
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }
    
    .data-table-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .svo-table {
        font-size: 0.9rem;
    }
    
    .svo-table th {
        background: #f8f9fa;
        color: #495057;
        font-weight: 600;
        border-bottom: 2px solid #3aa681;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .svo-table td {
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }
    
    .url-badge {
        background: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        font-size: 0.8rem;
        text-decoration: none;
        display: inline-block;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .url-badge:hover {
        background: #3aa681;
        color: white;
        text-decoration: none;
    }
    
    .context-tooltip {
        cursor: help;
        border-bottom: 1px dotted #6c757d;
    }
    
    .frequency-badge {
        background: #3aa681;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .action-buttons {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        text-align: center;
    }
    
    .btn-download {
        background: linear-gradient(135deg, #28a745 0%, #20732e 100%);
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: bold;
        margin: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        color: white;
    }
    
    .btn-new-analysis {
        background: linear-gradient(135deg, #3aa681 0%, #2c8563 100%);
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: bold;
        margin: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .btn-new-analysis:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(58, 166, 129, 0.3);
        color: white;
    }
    
    .session-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
    }
    
    .failed-urls {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
    }
    
    .frequency-list {
        max-height: 300px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
    }
    
    .frequency-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .frequency-item:last-child {
        border-bottom: none;
    }
    
    .frequency-word {
        font-weight: 500;
        color: #495057;
    }
    
    .frequency-count {
        background: #3aa681;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .orchid-icon {
        color: #3aa681;
        margin-right: 0.5rem;
    }
    
    .tab-content {
        margin-top: 1rem;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link.active {
        background: #3aa681;
        color: white;
        border-radius: 8px 8px 0 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Results Header -->
    <div class="results-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i data-feather="bar-chart-2" class="orchid-icon"></i>{{ session.session_name }}</h1>
                <p class="lead mb-0">SVO Analysis Results</p>
                <small>Analysis completed on {{ session.completed_at.strftime('%Y-%m-%d at %H:%M') if session.completed_at else 'Unknown' }}</small>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex flex-column">
                    <small class="text-light opacity-75">Duration</small>
                    <strong>
                        {% if session.started_at and session.completed_at %}
                            {{ ((session.completed_at - session.started_at).total_seconds() / 60) | round(1) }} minutes
                        {% else %}
                            Unknown
                        {% endif %}
                    </strong>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Info -->
    <div class="session-info">
        <div class="row">
            <div class="col-md-6">
                <h6><i data-feather="link" class="orchid-icon"></i>Analyzed URLs ({{ session.urls|length }})</h6>
                <ul class="list-unstyled">
                    {% for url in session.urls %}
                    <li class="mb-1">
                        <a href="{{ url }}" target="_blank" class="url-badge">{{ url }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-6">
                {% if session.failed_urls %}
                <div class="failed-urls">
                    <h6><i data-feather="alert-triangle" style="color: #721c24;"></i>Failed URLs ({{ session.failed_urls|length }})</h6>
                    {% for failed in session.failed_urls %}
                    <div class="small mb-1">
                        <strong>{{ failed.url }}</strong><br>
                        <span class="text-muted">{{ failed.error }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ summary.total_tuples if summary else results|length }}</div>
                <div class="stats-label">Total SVO Patterns</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ summary.unique_subjects if summary else 0 }}</div>
                <div class="stats-label">Unique Subjects</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ summary.unique_verbs if summary else 0 }}</div>
                <div class="stats-label">Unique Verbs</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ summary.unique_objects if summary else 0 }}</div>
                <div class="stats-label">Unique Objects</div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        {% if summary and summary.csv_export_path %}
        <a href="{{ url_for('svo_analysis.download_csv', session_id=session.id) }}" class="btn btn-download">
            <i data-feather="download"></i> Download CSV Export
        </a>
        {% endif %}
        <a href="{{ url_for('svo_analysis.index') }}" class="btn btn-new-analysis">
            <i data-feather="plus-circle"></i> Start New Analysis
        </a>
        <button class="btn btn-outline-danger" onclick="deleteSession('{{ session.id }}')">
            <i data-feather="trash-2"></i> Delete Session
        </button>
    </div>

    <!-- Charts and Data -->
    {% if summary %}
    <div class="row">
        <!-- Frequency Charts -->
        <div class="col-lg-8">
            <div class="chart-container">
                <h4><i data-feather="trending-up" class="orchid-icon"></i>Frequency Analysis</h4>
                
                <!-- Chart Tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#subjects-tab">
                            <i data-feather="users"></i> Subjects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#verbs-tab">
                            <i data-feather="zap"></i> Verbs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#objects-tab">
                            <i data-feather="target"></i> Objects
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div id="subjects-tab" class="tab-pane active">
                        {% if summary.subject_chart_path %}
                        <img src="{{ summary.subject_chart_path }}" alt="Subject Frequency Chart" class="chart-image">
                        {% else %}
                        <div class="text-center text-muted p-4">
                            <i data-feather="image" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p>Subject frequency chart not available</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div id="verbs-tab" class="tab-pane">
                        {% if summary.verb_chart_path %}
                        <img src="{{ summary.verb_chart_path }}" alt="Verb Frequency Chart" class="chart-image">
                        {% else %}
                        <div class="text-center text-muted p-4">
                            <i data-feather="image" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p>Verb frequency chart not available</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div id="objects-tab" class="tab-pane">
                        {% if summary.object_chart_path %}
                        <img src="{{ summary.object_chart_path }}" alt="Object Frequency Chart" class="chart-image">
                        {% else %}
                        <div class="text-center text-muted p-4">
                            <i data-feather="image" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p>Object frequency chart not available</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Frequency Lists -->
        <div class="col-lg-4">
            <div class="chart-container">
                <h5><i data-feather="list" class="orchid-icon"></i>Top Frequencies</h5>
                
                <!-- Frequency Tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#freq-subjects">Subjects</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#freq-verbs">Verbs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#freq-objects">Objects</a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div id="freq-subjects" class="tab-pane active">
                        <div class="frequency-list">
                            {% for word, count in summary.subject_frequencies.items() | sort(attribute='1', reverse=True) %}
                            {% if loop.index <= 10 %}
                            <div class="frequency-item">
                                <span class="frequency-word">{{ word }}</span>
                                <span class="frequency-count">{{ count }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div id="freq-verbs" class="tab-pane">
                        <div class="frequency-list">
                            {% for word, count in summary.verb_frequencies.items() | sort(attribute='1', reverse=True) %}
                            {% if loop.index <= 10 %}
                            <div class="frequency-item">
                                <span class="frequency-word">{{ word }}</span>
                                <span class="frequency-count">{{ count }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div id="freq-objects" class="tab-pane">
                        <div class="frequency-list">
                            {% for word, count in summary.object_frequencies.items() | sort(attribute='1', reverse=True) %}
                            {% if loop.index <= 10 %}
                            <div class="frequency-item">
                                <span class="frequency-word">{{ word }}</span>
                                <span class="frequency-count">{{ count }}</span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Raw Data Table -->
    <div class="data-table-container">
        <h4><i data-feather="database" class="orchid-icon"></i>Extracted SVO Patterns 
            <small class="text-muted">({{ results|length }} total)</small>
        </h4>
        
        {% if results %}
        <div class="table-responsive">
            <table class="table table-hover svo-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">Source</th>
                        <th style="width: 20%;">Subject</th>
                        <th style="width: 15%;">Verb</th>
                        <th style="width: 20%;">Object</th>
                        <th style="width: 30%;">Context</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td>
                            <a href="{{ result.source_url }}" target="_blank" class="url-badge">
                                {{ result.source_url.split('//')[1].split('/')[0] if '//' in result.source_url else result.source_url[:20] }}
                            </a>
                        </td>
                        <td><strong>{{ result.subject }}</strong></td>
                        <td><em>{{ result.verb }}</em></td>
                        <td><strong>{{ result.object }}</strong></td>
                        <td>
                            {% if result.context_text %}
                            <span class="context-tooltip" title="{{ result.context_text }}">
                                {{ result.context_text[:60] }}{% if result.context_text|length > 60 %}...{% endif %}
                            </span>
                            {% else %}
                            <span class="text-muted">No context</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center text-muted p-4">
            <i data-feather="inbox" style="font-size: 3rem; opacity: 0.3;"></i>
            <p>No SVO patterns extracted from the analyzed websites.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Delete session function
async function deleteSession(sessionId) {
    if (!confirm('Are you sure you want to delete this analysis session and all its data?')) {
        return;
    }
    
    try {
        const response = await fetch(`/svo/delete/${sessionId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            window.location.href = '/svo/';
        } else {
            alert('Failed to delete session');
        }
        
    } catch (error) {
        console.error('Error deleting session:', error);
        alert('Failed to delete session');
    }
}

// Initialize tooltips and feather icons
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips for context
    const tooltips = document.querySelectorAll('.context-tooltip');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });
    
    // Initialize feather icons
    safeFeatherReplace();
});
</script>
{% endblock %}