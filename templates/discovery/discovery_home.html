<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Orchid Species Discovery Game | Five Cities Orchid Society</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .discovery-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .discovery-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .level-badge {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 5px;
        }
        
        .achievement-badge {
            background: #ffd700;
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            margin: 3px;
            display: inline-block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .challenge-button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .challenge-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .progress-circle {
            transform: rotate(-90deg);
        }
        
        .daily-challenge {
            background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            color: #333;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .challenge-modal {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .streak-indicator {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .discovery-image {
            max-width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 10px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: rgba(0,0,0,0.3);">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i data-feather="compass"></i> 
                Discovery Game
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/discovery/leaderboard">
                    <i data-feather="trophy"></i> Leaderboard
                </a>
                <a class="nav-link" href="/">
                    <i data-feather="home"></i> Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- Welcome Section -->
        <div class="text-center text-white mb-5">
            <h1 class="display-4 mb-3">
                üéÆ Interactive Orchid Species Discovery
            </h1>
            <p class="lead">
                Explore the fascinating world of orchids through gamified discovery challenges!
                Learn to identify species, understand habitats, and become an orchid expert.
            </p>
        </div>

        <!-- User Stats Dashboard -->
        <div class="discovery-card">
            <h3 class="text-center text-white mb-4">
                <i data-feather="user"></i> Your Discovery Journey
            </h3>
            
            <div class="stats-grid" id="userStats">
                <div class="stat-item text-white">
                    <h4 id="totalDiscoveries">0</h4>
                    <p>Species Discovered</p>
                </div>
                <div class="stat-item text-white">
                    <h4 id="totalPoints">0</h4>
                    <p>Total Points</p>
                </div>
                <div class="stat-item text-white">
                    <h4 id="currentStreak">0</h4>
                    <p>Current Streak</p>
                </div>
                <div class="stat-item text-white">
                    <h4 id="userLevel">Beginner</h4>
                    <p>Current Level</p>
                </div>
            </div>
            
            <div class="text-center">
                <div class="streak-indicator" id="streakIndicator" style="display: none;">
                    üî• <span id="streakText">Amazing streak!</span>
                </div>
            </div>
        </div>

        <!-- Daily Challenge -->
        <div class="daily-challenge" id="dailyChallenge">
            <h4><i data-feather="star"></i> Today's Special Challenge</h4>
            <p id="dailyChallengeDesc">Loading today's challenge...</p>
            <button class="btn btn-dark btn-lg" onclick="startDailyChallenge()">
                <i data-feather="play"></i> Start Daily Challenge
            </button>
        </div>

        <!-- Challenge Categories -->
        <div class="row">
            <div class="col-md-6">
                <div class="discovery-card">
                    <h4 class="text-white mb-3">
                        <i data-feather="camera"></i> Photo Identification
                    </h4>
                    <p class="text-light">
                        Test your visual identification skills! Can you identify orchid species from photos?
                    </p>
                    <div class="level-selection mb-3">
                        <select class="form-select" id="photoLevel">
                            <option value="beginner">üå± Beginner Explorer</option>
                            <option value="intermediate">üîç Species Detective</option>
                            <option value="advanced">üéì Orchid Master</option>
                            <option value="expert">üë®‚Äçüî¨ Taxonomist</option>
                        </select>
                    </div>
                    <button class="challenge-button" onclick="startChallenge('photo_id')">
                        <i data-feather="play"></i> Start Challenge
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="discovery-card">
                    <h4 class="text-white mb-3">
                        <i data-feather="layers"></i> Genus Matching
                    </h4>
                    <p class="text-light">
                        Match orchids to their correct genus classification. Learn botanical taxonomy!
                    </p>
                    <div class="level-selection mb-3">
                        <select class="form-select" id="genusLevel">
                            <option value="beginner">üå± Beginner Explorer</option>
                            <option value="intermediate">üîç Species Detective</option>
                            <option value="advanced">üéì Orchid Master</option>
                            <option value="expert">üë®‚Äçüî¨ Taxonomist</option>
                        </select>
                    </div>
                    <button class="challenge-button" onclick="startChallenge('genus_match')">
                        <i data-feather="play"></i> Start Challenge
                    </button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="discovery-card">
                    <h4 class="text-white mb-3">
                        <i data-feather="map-pin"></i> Habitat Detective
                    </h4>
                    <p class="text-light">
                        Guess where these orchids naturally grow. Explore global biodiversity!
                    </p>
                    <div class="level-selection mb-3">
                        <select class="form-select" id="habitatLevel">
                            <option value="beginner">üå± Beginner Explorer</option>
                            <option value="intermediate">üîç Species Detective</option>
                            <option value="advanced">üéì Orchid Master</option>
                            <option value="expert">üë®‚Äçüî¨ Taxonomist</option>
                        </select>
                    </div>
                    <button class="challenge-button" onclick="startChallenge('habitat_guess')">
                        <i data-feather="play"></i> Start Challenge
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="discovery-card">
                    <h4 class="text-white mb-3">
                        <i data-feather="calendar"></i> Flowering Calendar
                    </h4>
                    <p class="text-light">
                        Predict when different orchid species bloom throughout the year.
                    </p>
                    <div class="level-selection mb-3">
                        <select class="form-select" id="bloomLevel">
                            <option value="beginner">üå± Beginner Explorer</option>
                            <option value="intermediate">üîç Species Detective</option>
                            <option value="advanced">üéì Orchid Master</option>
                            <option value="expert">üë®‚Äçüî¨ Taxonomist</option>
                        </select>
                    </div>
                    <button class="challenge-button" onclick="startChallenge('bloom_time')">
                        <i data-feather="play"></i> Start Challenge
                    </button>
                </div>
            </div>
        </div>

        <!-- Rapid Fire Round -->
        <div class="discovery-card text-center">
            <h4 class="text-white mb-3">
                <i data-feather="zap"></i> Rapid Fire Round
            </h4>
            <p class="text-light">
                Quick identification challenges! How many can you get right in 60 seconds?
            </p>
            <button class="challenge-button btn-lg" onclick="startChallenge('rapid_fire')">
                <i data-feather="zap"></i> Start Rapid Fire
            </button>
        </div>

        <!-- Recent Achievements -->
        <div class="discovery-card" id="achievementsSection" style="display: none;">
            <h4 class="text-white mb-3">
                <i data-feather="award"></i> Your Achievements
            </h4>
            <div id="achievementsList">
                <!-- Achievements will be populated here -->
            </div>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div class="modal fade challenge-modal" id="challengeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="challengeTitle">Challenge Loading...</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="challengeContent">
                        <div class="text-center">
                            <i data-feather="loader" class="loading-spinner" style="width: 48px; height: 48px;"></i>
                            <p>Loading your challenge...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="challengeTimer" class="me-auto">
                        <i data-feather="clock"></i> <span id="timeLeft">60</span>s
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Exit Challenge</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title">Challenge Results</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="playAgain()">Play Again</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentChallenge = null;
        let challengeTimer = null;
        let challengeStartTime = null;
        let playerName = 'Anonymous Explorer';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            loadUserStats();
            loadDailyChallenge();
            
            // Get player name
            playerName = prompt('Enter your name for the leaderboard:') || 'Anonymous Explorer';
        });

        async function loadUserStats() {
            try {
                const response = await fetch('/discovery/api/user-stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('totalDiscoveries').textContent = stats.total_discoveries;
                    document.getElementById('totalPoints').textContent = stats.total_points.toLocaleString();
                    document.getElementById('currentStreak').textContent = stats.current_streak;
                    document.getElementById('userLevel').textContent = stats.level.charAt(0).toUpperCase() + stats.level.slice(1);
                    
                    // Show streak indicator if active
                    if (stats.current_streak >= 3) {
                        const streakIndicator = document.getElementById('streakIndicator');
                        document.getElementById('streakText').textContent = `${stats.current_streak} challenge streak! Keep going!`;
                        streakIndicator.style.display = 'inline-block';
                    }
                    
                    // Show achievements if any
                    if (data.achievements && data.achievements.length > 0) {
                        displayAchievements(data.achievements);
                    }
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        async function loadDailyChallenge() {
            try {
                const response = await fetch('/discovery/api/daily-challenge');
                const data = await response.json();
                
                if (data.success) {
                    const challenge = data.daily_challenge;
                    document.getElementById('dailyChallengeDesc').textContent = 
                        `${challenge.title} - ${challenge.description} (${challenge.points_possible} points)`;
                }
            } catch (error) {
                console.error('Error loading daily challenge:', error);
            }
        }

        async function startChallenge(challengeType) {
            const levelSelectors = {
                'photo_id': 'photoLevel',
                'genus_match': 'genusLevel',
                'habitat_guess': 'habitatLevel',
                'bloom_time': 'bloomLevel'
            };
            
            const level = levelSelectors[challengeType] ? 
                document.getElementById(levelSelectors[challengeType]).value : 'beginner';

            try {
                const response = await fetch('/discovery/api/start-challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challenge_type: challengeType,
                        level: level,
                        player_name: playerName
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentChallenge = data.challenge;
                    displayChallenge(currentChallenge);
                    document.getElementById('challengeModal').style.display = 'block';
                    new bootstrap.Modal(document.getElementById('challengeModal')).show();
                } else {
                    alert('Error starting challenge: ' + data.error);
                }
            } catch (error) {
                console.error('Error starting challenge:', error);
                alert('Failed to start challenge. Please try again.');
            }
        }

        async function startDailyChallenge() {
            try {
                const response = await fetch('/discovery/api/daily-challenge');
                const data = await response.json();
                
                if (data.success) {
                    // Start the daily challenge as a regular challenge
                    const challengeResponse = await fetch('/discovery/api/start-challenge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            challenge_type: data.daily_challenge.type,
                            level: 'intermediate',
                            player_name: playerName
                        })
                    });
                    
                    const challengeData = await challengeResponse.json();
                    if (challengeData.success) {
                        currentChallenge = challengeData.challenge;
                        currentChallenge.is_daily = true;
                        displayChallenge(currentChallenge);
                        new bootstrap.Modal(document.getElementById('challengeModal')).show();
                    }
                }
            } catch (error) {
                console.error('Error starting daily challenge:', error);
            }
        }

        function displayChallenge(challenge) {
            document.getElementById('challengeTitle').textContent = challenge.title;
            
            if (challenge.type === 'rapid_fire') {
                displayRapidFireChallenge(challenge);
            } else {
                displayRegularChallenge(challenge);
            }
            
            // Start timer
            startChallengeTimer(challenge.time_limit);
        }

        function displayRegularChallenge(challenge) {
            const content = document.getElementById('challengeContent');
            
            let hintsHtml = '';
            if (challenge.hints && challenge.hints.length > 0) {
                hintsHtml = `
                    <div class="mt-3">
                        <h6>Hints:</h6>
                        <ul class="list-unstyled">
                            ${challenge.hints.map(hint => `<li><i data-feather="lightbulb"></i> ${hint}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="text-center">
                    <img src="${challenge.image_url}" alt="Orchid Challenge" class="discovery-image">
                    <h5>${challenge.question}</h5>
                    <div class="my-3">
                        ${challenge.options.map(option => `
                            <button class="btn btn-outline-light btn-lg d-block w-100 my-2" 
                                    onclick="submitAnswer(${option.id})">
                                ${option.text}
                            </button>
                        `).join('')}
                    </div>
                    ${hintsHtml}
                    <div class="mt-3">
                        <small class="text-muted">Points possible: ${challenge.points_possible}</small>
                    </div>
                </div>
            `;
            
            feather.replace();
        }

        function displayRapidFireChallenge(challenge) {
            const content = document.getElementById('challengeContent');
            content.innerHTML = `
                <div class="text-center">
                    <h5>Get ready for rapid fire!</h5>
                    <p>${challenge.questions.length} quick questions - ${challenge.questions[0].time_limit} seconds each!</p>
                    <button class="btn btn-primary btn-lg" onclick="startRapidFireRound()">
                        <i data-feather="zap"></i> Start Now!
                    </button>
                </div>
            `;
            feather.replace();
        }

        function startChallengeTimer(timeLimit) {
            challengeStartTime = Date.now();
            let timeLeft = timeLimit;
            
            const timerElement = document.getElementById('timeLeft');
            timerElement.textContent = timeLeft;
            
            challengeTimer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(challengeTimer);
                    submitAnswer(-1); // Time's up
                }
            }, 1000);
        }

        async function submitAnswer(answer) {
            if (!currentChallenge) return;
            
            clearInterval(challengeTimer);
            const timeSpent = Math.floor((Date.now() - challengeStartTime) / 1000);
            
            try {
                const response = await fetch('/discovery/api/submit-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challenge_id: currentChallenge.challenge_id,
                        answer: answer,
                        time_taken: timeSpent
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    displayResults(result);
                } else {
                    alert('Error submitting answer: ' + result.error);
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('Failed to submit answer. Please try again.');
            }
        }

        function displayResults(result) {
            bootstrap.Modal.getInstance(document.getElementById('challengeModal')).hide();
            
            const content = document.getElementById('resultsContent');
            const isCorrect = result.correct;
            const resultIcon = isCorrect ? '‚úÖ' : '‚ùå';
            const resultText = isCorrect ? 'Correct!' : 'Incorrect';
            const pointsText = result.points_earned > 0 ? `+${result.points_earned} points` : 'No points earned';
            
            let achievementsHtml = '';
            if (result.new_achievements && result.new_achievements.length > 0) {
                achievementsHtml = `
                    <div class="alert alert-warning mt-3">
                        <h6>üèÜ New Achievements Unlocked!</h6>
                        ${result.new_achievements.map(ach => `
                            <span class="achievement-badge">${ach.icon} ${ach.name}</span>
                        `).join('')}
                    </div>
                `;
            }
            
            let levelUpHtml = '';
            if (result.level_progress && result.level_progress.level_up) {
                levelUpHtml = `
                    <div class="alert alert-success mt-3">
                        <h6>üéâ Level Up!</h6>
                        <p>You've advanced to ${result.level_progress.new_level}!</p>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="text-center">
                    <h2>${resultIcon} ${resultText}</h2>
                    <h4 class="text-primary">${pointsText}</h4>
                    
                    ${result.current_streak > 0 ? `
                        <div class="streak-indicator mt-3">
                            üî• Streak: ${result.current_streak}
                        </div>
                    ` : ''}
                    
                    <div class="mt-3">
                        <h6>Explanation:</h6>
                        <p>${result.explanation}</p>
                    </div>
                    
                    <div class="mt-3">
                        <small>Total Points: ${result.total_points.toLocaleString()}</small>
                    </div>
                    
                    ${achievementsHtml}
                    ${levelUpHtml}
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('resultsModal')).show();
            
            // Reload stats
            loadUserStats();
        }

        function displayAchievements(achievements) {
            const achievementsSection = document.getElementById('achievementsSection');
            const achievementsList = document.getElementById('achievementsList');
            
            achievementsList.innerHTML = achievements.map(ach => `
                <span class="achievement-badge">${ach.icon} ${ach.name}</span>
            `).join('');
            
            achievementsSection.style.display = 'block';
        }

        function playAgain() {
            bootstrap.Modal.getInstance(document.getElementById('resultsModal')).hide();
            // Could prompt for same challenge type or return to menu
        }

        // Close modals properly
        document.getElementById('challengeModal').addEventListener('hidden.bs.modal', function() {
            if (challengeTimer) {
                clearInterval(challengeTimer);
            }
            currentChallenge = null;
        });
    </script>
</body>
</html>